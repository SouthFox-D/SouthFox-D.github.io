<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" /><meta property="og:title" content="æ­å»ºMatrixå³æ—¶é€šä¿¡æœåŠ¡ â€” ç‹ç‹¸åèµ°çŸ£" /><meta property="og:site_name" content="ç‹ç‹¸åèµ°çŸ£" /><meta property="og:image" content="https://blog.southfox.me/favicon.png" /><meta name="fediverse:creator" content="SouthFox@foxsay.southfox.me" /><title>æ­å»ºMatrixå³æ—¶é€šä¿¡æœåŠ¡ â€” ç‹ç‹¸åèµ°çŸ£</title><link rel="me" href="https://foxsay.southfox.me/@SouthFox" /><link rel="me" href="https://codeberg.org/southfox" /><script src="/assets/js/lips.min.js"></script><link rel="stylesheet" href="/assets/css/main.css" /><script type="text/x-scheme">(let ((font (or (localStorage.getItem "font") "zpix")) (font-select (document.getElementById "font-select"))) (define (string=? a b) (== (a.cmp b) 0)) (define (loop-set options value) (let loop ((i 0)) (if (> i (- (length options) 1)) i (let ((option (get options i))) (if (string=? option.value value) (option.setAttribute "selected" #t) (loop (+ 1 i))))))) (define (set-font font-name) (localStorage.setItem "font" font-name) (document.documentElement.setAttribute "data-font" font-name) (if font-select (loop-set font-select.options font-name))) (font-select.addEventListener "change" (lambda (event) (set-font event.target.value))) (set-font font))</script><link rel="alternative" href="/feed.xml" title="ç‹ç‹¸åèµ°çŸ£" type="application/atom+xml" /><link rel="alternative" href="/rss2.xml" title="ç‹ç‹¸åèµ°çŸ£" type="application/rss+xml" /></head><body><nav class="nav"><a href="/" class="brand"><span>ç‹ç‹¸åèµ°çŸ£</span></a><input id="bmenub" type="checkbox" class="show" aria-label="open menu" /><label for="bmenub" class="burger pseudo button">â˜°</label><div class="menu"><a href="/archives/">å½’æ¡£</a><a href="/tags/">æ ‡ç­¾</a><a href="/search/">æœç´¢</a><a href="/about/">å…³äº</a></div></nav><div class="container flex"><div class="content"><main data-pagefind-body="true"><div><h2>æ­å»ºMatrixå³æ—¶é€šä¿¡æœåŠ¡</h2><h3>by SouthFox</h3><h3 data-pagefind-sort="date">2022-04-15</h3><div><p>æ€»ä¹‹ç¨å¾®è®°å½•ä¸€ä¸‹ã€‚</p><span id="more"></span><ul><li><p>äº‹å…ˆçº¦å®š <code>matrix.org</code> æ˜¯å‰ç«¯åœ°å€ <code>synapse.matrix.org</code> æ˜¯åç«¯åœ°å€ï¼Œå®é™…è¯·æ”¹æˆè‡ªå·±çš„â€¦â€¦å…·ä½“ä¸ºå•¥è¿™ä¹ˆåšå¯ä»¥çœ‹<a href="https://matrix-org.github.io/synapse/latest/delegate.html" class="external_link">å®˜æ–¹æ–‡æ¡£</a>ï¼Œå¦‚æœå«Œéº»çƒ¦ä¹Ÿå¯ä»¥ä¸å¯ç”¨è¿™åŠŸèƒ½â€¦â€¦</p></li><li><p>æ–°å»ºæ–‡ä»¶å¤¹ï¼Œåœ¨é‡Œé¢æ–°å»ºä¸€ä¸ª <code>docker-compose.yml</code> æ–‡ä»¶ï¼Œå¾€é‡Œå†™å…¥</p></li></ul><pre><code>#ä¹Ÿæ„Ÿè°¢ç³–å–µæä¾›çš„é…ç½®æ–‡ä»¶~
version: &quot;3.4&quot;

services:
  synapse:
    hostname: matrix
    image: matrixdotorg/synapse:latest
    restart: always
    container_name: matrix_server   
    depends_on:
      - db
      - redis
    ports:
      - &quot;127.0.0.1:8001:8008&quot;
    volumes:
      - ./synapse/data:/data
    networks:
      - synapse_network
      - external_network
    healthcheck:
      test: [&quot;CMD-SHELL&quot;, &quot;curl -s localhost:8008/health || exit 1&quot;]

  db:
    image: postgres
    restart: always
    container_name: matrix_db
    volumes:
      - ./synapse/db:/var/lib/postgresql/data
    environment:
      POSTGRES_USER: synapse
      POSTGRES_PASSWORD: éšä¾¿ä»€ä¹ˆå¯†ç 
      POSTGRES_DB: synapse
      POSTGRES_INITDB_ARGS: &quot;--encoding='UTF8' --lc-collate='C' --lc-ctype='C'&quot;
    networks:
      - synapse_network
    healthcheck:
      test: [&quot;CMD&quot;, &quot;pg_isready&quot;, &quot;-U&quot;, &quot;synapse&quot;]

  redis:
    image: redis:6.0-alpine
    restart: always
    container_name: matrix_redis  
    volumes:
      - ./synapse/redis:/data
    networks:
      - synapse_network
    healthcheck:
      test: [&quot;CMD&quot;, &quot;redis-cli&quot;, &quot;ping&quot;]

networks:
  synapse_network:
    internal: true
  external_network:</code></pre><ul><li>ä¹‹åè¿è¡Œ <code>docker-compose run --rm -e SYNAPSE_SERVER_NAME=å‰ç«¯åœ°å€ synapse generate</code> å‘½ä»¤ç”Ÿæˆé…ç½®æ–‡ä»¶ï¼Œä¹‹åæ£€æŸ¥åœ¨ <code>./synapse/data</code> è·¯å¾„ä¸‹æ˜¯å¦æœ‰å« <code>homeserver.yaml</code> çš„é…ç½®æ–‡ä»¶ï¼Œç¼–è¾‘é…ç½®æ–‡ä»¶ <code>nano ./synapse/data/homeserver.yaml</code></li></ul><pre><code># é‡ç‚¹æ”¹ä»¥ä¸‹é…ç½®
server_name: &quot;matrix.org&quot;

public_baseurl: https://synapse.matrix.org/

serve_server_wellknown: true

database:
  name: psycopg2
  txn_limit: 10000
  args:
    user: synapse
    password: docker é…ç½®å†™çš„éšä¾¿ä»€ä¹ˆå¯†ç 
    database: synapse
    host: db
    port: 5432
    cp_min: 5
    cp_max: 10

#database:
#  name: sqlite3
#  args:
#    database: /data/homeserver.db
#â†‘æ³¨é‡Šæ‰ä½¿ç”¨ sqlite3 çš„é…ç½®

redis:
  # Uncomment the below to enable Redis support.
  #
  enabled: true

  # Optional host and port to use to connect to redis. Defaults to
  # localhost and 6379
  #
  host: redis
  port: 6379</code></pre><ul><li>ä¹‹åå†å¯åŠ¨æœåŠ¡ï¼Œ<code>docker-compose start</code></li><li>ç¼–è¾‘ <code>matrix.org</code> çš„ <code>nginx</code> é…ç½®æ–‡ä»¶åŠ å…¥ä»¥ä¸‹é…ç½®</li></ul><pre><code>    location /.well-known/matrix/client {
        return 200 '{&quot;m.homeserver&quot;: {&quot;base_url&quot;: &quot;https://synapse.matrix.org&quot;}}';
        default_type application/json;
        add_header Access-Control-Allow-Origin *;
    }

    location /.well-known/matrix/server {
        return 200 '{&quot;m.server&quot;: &quot;synapse.matrix.org:443&quot;}';
        default_type application/json;
        add_header Access-Control-Allow-Origin *;
    }
#æ³¨æ„æ›¿æ¢è‡ªå·±çš„å‰ç«¯åç«¯åœ°å€</code></pre><ul><li>æ–°å»º <code>synapse.matrix.org</code> çš„ <code>dns</code> ï¼ŒæŒ‡å‘æœåŠ¡å™¨åœ°å€ï¼Œå† <code>certbot certonly --nginx -d synapse.matrix.org</code> ç”³è¯·è¯ä¹¦</li><li>æ–°å»ºä¸€ä¸ª <code>synapse.matrix.org</code> çš„é…ç½®æ–‡ä»¶</li></ul><pre><code>server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;

    server_name synapse.matrix.org;

    ssl_certificate /etc/letsencrypt/live/synapse.matrix.org/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/synapse.matrix.org/privkey.pem;

    # Various TLS hardening settings
    # https://raymii.org/s/tutorials/Strong_SSL_Security_On_nginx.html
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-SHA384;
    ssl_session_timeout  10m;
    ssl_session_cache shared:SSL:10m;
    ssl_session_tickets on;
    ssl_stapling on;
    ssl_stapling_verify on;


    location ~ ^(/_matrix|/_synapse/client) {
        # note: do not add a path (even a single /) after the port in `proxy_pass`,
        # otherwise nginx will canonicalise the URI and cause signature verification
        # errors.
        proxy_pass http://127.0.0.1:8001;
        proxy_set_header X-Forwarded-For $remote_addr;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Host $host;

        # Nginx by default only allows file uploads up to 1M in size
        # Increase client_max_body_size to match max_upload_size defined in homeserver.yaml
        client_max_body_size 500M;
    }

}</code></pre><ul><li>é‡è½½ <code>nginx</code> é…ç½®æ–‡ä»¶ï¼Œ<code>nginx -s reload</code></li><li>ä¹‹åå»<a href="https://federationtester.matrix.org/" class="external_link">æ£€æŸ¥æœåŠ¡</a>ï¼ˆéœ€ç§‘å­¦ï¼‰è¾“å…¥è‡ªå·±çš„å‰ç«¯åœ°å€ <code>matrix.org</code> æ£€æŸ¥æ˜¯å¦æ­£å¸¸</li><li>ç”¨ <code>docker-compose exec synapse /bin/bash</code> è¿›å…¥ <code>synapse</code> å®¹å™¨</li></ul><pre><code>cd data
#æ³¨å†Œæ–°ç”¨æˆ·
register_new_matrix_user -c homeserver.yaml http://localhost:8008 
#æ³¨å†Œå®Œåç”¨ exit é€€å‡ºå®¹å™¨
exit</code></pre><ul><li>å®Œæˆåç”¨ä»»æ„ä¸€ä¸ªå®¢æˆ·ç«¯ç™»é™†å³å¯ä½¿ç”¨ï¼Œæ³¨æ„ç™»é™†ç”¨çš„åœ°å€æ˜¯åç«¯åœ°å€ <code>synapse.matrix.org</code></li></ul></div></div></main><div class="pagination"><a class="btn" href="/2022/04/Emacséšè®°ï¼ˆ1ï¼‰/">â† ä¸Šä¸€é¡µ</a><a class="btn" href="/"> ä¸»é¡µ </a><a class="btn" href="/2022/04/EFK-æ—¥å¿—-All-in-one/">ä¸‹ä¸€é¡µ â†’</a></div><div class="comment"><blockquote>å¦‚ä¸æƒ³æˆæƒ Giscus åº”ç”¨ï¼Œä¹Ÿå¯ä»¥ç‚¹å‡»ä¸‹æ–¹<strong>å·¦ä¸Šè§’æ•°å­—</strong>ç›´æ¥è·³è½¬åˆ° Github Discussions è¿›è¡Œè¯„è®ºã€‚</blockquote><script src="https://giscus.app/client.js" data-repo="SouthFox-D/SouthFox-D.github.io" data-repo-id="MDEwOlJlcG9zaXRvcnkyMjg3NDM0MjQ=" data-category="åšå®¢è¯„è®º" data-category-id="DIC_kwDODaJZAM4CA7bf" data-mapping="specific" data-term="2022/04/æ­å»ºMatrixå³æ—¶é€šä¿¡æœåŠ¡/" data-reactions-enabled="0" data-emit-metadata="0" data-input-position="top" data-theme="dark_dimmed" data-lang="zh-CN" data-loading="lazy" crossorigin="anonymous" async=""></script></div></div><div class="sidebar"><div class="widget"><h4>é“¾æ¥</h4><ul><li><a href="/friends/">å‹é“¾</a></li><li><a href="https://www.travellings.cn/train.html">å¼€å¾€</a></li><li><a href="https://foreverblog.cn/go.html">è™«æ´</a></li><li><a href="/feed.xml">è®¢é˜…ï¼ˆAtom)</a></li><li><a href="/rss2.xml">è®¢é˜…ï¼ˆRss)</a></li><li><a href="https://www.lisperati.com/logo.html"><img src="/assets/img/lisplogo_warning2_128.png" alt="Lisp logo warning" /></a></li><li><a href="https://www.fsf.org/appeal"><img src="/assets/img/6838639.png" alt="FSF appeal" /></a></li></ul><div><a href="https://xn--sr8hvo.ws/previous">â†</a><a href="https://xn--sr8hvo.ws">IndieWeb Webring ğŸ’</a><a href="https://xn--sr8hvo.ws/next">â†’</a></div><div><a href="https://fediring.net/previous?host=blog.southfox.me">â†</a><a href="https://fediring.net">Fediring ğŸ’</a><a href="https://fediring.net/next?host=blog.southfox.me">â†’</a></div></div><div class="widget"><h4>è®¾ç½®</h4><div><label for="font-select">å­—ä½“è®¾ç½®ï¼š</label><select id="font-select"><option value="plain">æ™®é€š</option><option value="zpix">åƒç´ </option></select></div></div><div class="widget"><h4>æ ‡ç­¾</h4><ul><li><a href="/tag/æŠ€æœ¯">æŠ€æœ¯</a></li></ul></div><div class="widget"><h4>ç›®å½•</h4><ul></ul></div></div></div><footer class="footer"><div class="copyright"><div><p>Â© SouthFox 2026 ,Font by <a href="https://github.com/SolidZORO/zpix-pixel-font">Zpix</a></p></div><div><p>Power by <a href="https://dthompson.us/projects/haunt.html">haunt</a> ,source can be found <a href="https://git.southfox.me/southfox/blog">here</a></p></div></div></footer></body></html>