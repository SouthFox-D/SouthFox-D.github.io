<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" /><meta property="og:title" content="搭建无污染的DNS服务 — 狐狸反走矣" /><meta property="og:site_name" content="狐狸反走矣" /><meta property="og:image" content="https://blog.southfox.me/favicon.png" /><meta name="fediverse:creator" content="SouthFox@foxsay.southfox.me" /><title>搭建无污染的DNS服务 — 狐狸反走矣</title><link rel="me" href="https://foxsay.southfox.me/@SouthFox" /><link rel="me" href="https://codeberg.org/southfox" /><script src="/assets/js/lips.min.js"></script><link rel="stylesheet" href="/assets/css/main.css" /><script type="text/x-scheme">(let ((font (or (localStorage.getItem "font") "zpix")) (font-select (document.getElementById "font-select"))) (define (string=? a b) (== (a.cmp b) 0)) (define (loop-set options value) (let loop ((i 0)) (if (> i (- (length options) 1)) i (let ((option (get options i))) (if (string=? option.value value) (option.setAttribute "selected" #t) (loop (+ 1 i))))))) (define (set-font font-name) (localStorage.setItem "font" font-name) (document.documentElement.setAttribute "data-font" font-name) (if font-select (loop-set font-select.options font-name))) (font-select.addEventListener "change" (lambda (event) (set-font event.target.value))) (set-font font))</script><link rel="alternative" href="/feed.xml" title="狐狸反走矣" type="application/atom+xml" /><link rel="alternative" href="/rss2.xml" title="狐狸反走矣" type="application/rss+xml" /></head><body><nav class="nav"><a href="/" class="brand"><span>狐狸反走矣</span></a><input id="bmenub" type="checkbox" class="show" aria-label="open menu" /><label for="bmenub" class="burger pseudo button">☰</label><div class="menu"><a href="/archives/">归档</a><a href="/tags/">标签</a><a href="/search/">搜索</a><a href="/about/">关于</a></div></nav><div class="container flex"><div class="content"><main data-pagefind-body="true"><div><h2>搭建无污染的DNS服务</h2><h3>by SouthFox</h3><h3 data-pagefind-sort="date">2021-07-06</h3><div><p>DNS 作为互联网世界的电话簿，重要性不言而喻。但是平常使用时，默认情况都是在裸奔，非常不安全，劫持和污染处处存在，所以搭建一个自己放心的 DNS 服务还是有必要的……</p><span id="more"></span><h2 id="准备">准备</h2><ul><li>VPS （国内延迟低、国外无阻碍，看取舍吧。有条件也可以用树莓派之类的）</li><li>coredns（用于配置服务器的 Dns Over Tls 「dot」或 Dns Over Https 「doh」）</li><li>dnsmasq（用于转发 dns 请求）</li><li>pihole（可选，可以干掉追踪器和广告）</li><li>dnsproxy（将请求转发到其他加密 DNS 服务器上）</li></ul><h3 id="Coredns">Coredns</h3><p>安卓自从 9 版本之后就内置了 Dns Over Tls 「dot」 配置，叫做 <code>私人DNS</code> ，这样进行配置就不用一个一个改 wifi 设定，同时还对蜂窝网络起效果，所以可以用 <code>CoreDNS</code>  来加密设备到服务器之间的请求……</p><p><code>CoreDNS</code> 同样使用 <code>Golang</code> 编写，仓库内提供了<a href="https://github.com/coredns/coredns/releases" class="external_link">可执行程序</a> 和 <a href="https://github.com/coredns/deployment/tree/master/systemd" class="external_link">systemd</a>文件，就算你的发行版没有提供 <code>CoreDNS</code> 的打包也可以自行写个服务。</p><p>配置如下：</p><pre><code>tls://.:853 {
  tls /etc/coredns/cert.crt /etc/coredns/cert.key
    forward . 127.0.0.1:53
}</code></pre><p>作用是将 853 端口的 dot 请求转发到 53 端口所运行的服务上……</p><p>证书用 <code>certbot</code> 申请，偷偷摸摸的用 853 ，国内的云服务商应该不会注意到（毕竟盯着的是 443 和 80 端口的情况多一点……吧）</p><h3 id="Pihole（可选）">Pihole （可选）</h3><p><code>pihole</code> 的好处就是网页的控制面板很好用，看着面板中的统计数据将有非常大的满足感，除此之外就没有啥了。</p><p>如果不是全新机子的话，还是用 <code>docker-compose</code> 安装吧，pihole 对于安装环境还是很挑剔的。</p><p>首先安装 <code>docker</code> 并启动，然后安装 <code>docker-compose</code> ，新建文件夹下新建 <code>docker-compose.yml</code> 文件，输入：</p><pre><code>version: &quot;3&quot;

# More info at https://github.com/pi-hole/docker-pi-hole/ and https://docs.pi-hole.net/
services:
  pihole:
    container_name: pihole
    image: pihole/pihole:latest
    ports:
      - &quot;53:53/tcp&quot;
      - &quot;53:53/udp&quot;
      - &quot;67:67/udp&quot;
      - &quot;宿主机想开放的端口:下方配置 WEB_PORT 所写/tcp&quot;
    environment:
      TZ: 'Asia/Shanghai'
      WEBPASSWORD: '网页管理面板密码'
      WEB_PORT: 需要开放的端口
      PIHOLE_DNS_: '8.8.8.8'
      ServerIP: '服务器 Ip'
      #VIRTUAL_HOST: '服务器访问管理面板域名'
      #DNSMASQ_USER: 'pihole'

    volumes:
      - './etc-pihole/:/etc/pihole/'
      - './etc-dnsmasq.d/:/etc/dnsmasq.d/'
    # Recommended but not required (DHCP needs NET_ADMIN)
    #   https://github.com/pi-hole/docker-pi-hole#note-on-capabilities
    cap_add:
      - NET_ADMIN
    restart: unless-stopped</code></pre><p>注意 <code>ServerIP</code> 和 <code>VIRTUAL_HOST</code> 要写对，要不然会被禁止访问……</p><h4 id="列表">列表</h4><p>装了 pihole 要发挥最大的作用就得找一个优质的屏蔽列表。</p><p>可以使用 <a href="https://github.com/privacy-protection-tools/anti-AD" class="external_link">anti-AD</a> ，能屏蔽国内大部分追踪器和广告地址，对于 pihole 的配置文件在 <a href="https://anti-ad.net/domains.txt" class="external_link">这</a> 。</p><h3 id="Dnsmasq">Dnsmasq</h3><p>打开配置文件，更改 <code>port</code> 监听端口， <code>server</code>  写上游 dns 地址（<code>:</code> 要用 <code>#</code> 代替）。</p><p>无日志的 <code>dot</code> , <code>doh</code> 服务器一般都是在国外，一般延迟都很糟糕，所以对于国内的域名来说访问延迟将会很大。可以用 <code>Dnsmasq</code> 搭配 <a href="https://github.com/felixonmars/dnsmasq-china-list" class="external_link">dnsmasq-china-list</a> 项目，起到分流的作用，国内的常用域名送到国内的公共 DNS 服务解析，除此之外走加密的 DNS 服务。</p><p>不想装 <code>pihole</code> 的话，可以使用 <a href="https://github.com/privacy-protection-tools/anti-AD" class="external_link">anti-AD</a> 项目里的 <a href="https://anti-ad.net/anti-ad-for-dnsmasq.conf" class="external_link">anti-ad-for-dnsmasq.conf</a> 配置文件……</p><h3 id="Dnsproxy">Dnsproxy</h3><p>转发到上游的 dot 、 doh 请求。</p><p>项目地址在 <a href="https://github.com/AdguardTeam/dnsproxy" class="external_link">这里</a> ，而且似乎没有提供服务文件，所以得用 <code>screen</code> 挂着了。</p><p>基本上能用的 dot  、 doh 服务器被 <a href="https://www.solidot.org/story?sid=67104" class="external_link">封</a> 的差不多了，能用的 只有 <code>Cloudflare</code> 的了，如果对无日志不在意的话可以用腾讯云的 <code>dnspod</code> 。</p><h2 id="总结">总结</h2><p>到此，一个长长的 dns 链条就形成了：</p><pre><code>手机 -- dot 请求 --&gt; coredns --&gt; pihole -- 屏蔽或放行 --&gt; dnsmasq -- 分流 --&gt; 国内列表/列表外 --&gt; dnsproxy --&gt; dot/doh 服务器</code></pre><p>如果不贪恋 <code>pihole</code> 的控制面板的话，它的功能完全可以交给 <code>dnsmasq</code> 的。</p><p>只是没有控制面板的话，查误杀之类的事就会很麻烦……</p><p>搭好后应该使用抓包程序查看数据包，判断设备到服务器是否 套上了 tls ，服务器查看日志，看是否走了加密 dns 服务。</p></div></div></main><div class="pagination"><a class="btn" href="/2021/09/Second-chance/">← 上一页</a><a class="btn" href="/"> 主页 </a><a class="btn" href="/2021/06/Peertube/">下一页 →</a></div><div class="comment"><blockquote>如不想授权 Giscus 应用，也可以点击下方<strong>左上角数字</strong>直接跳转到 Github Discussions 进行评论。</blockquote><script src="https://giscus.app/client.js" data-repo="SouthFox-D/SouthFox-D.github.io" data-repo-id="MDEwOlJlcG9zaXRvcnkyMjg3NDM0MjQ=" data-category="博客评论" data-category-id="DIC_kwDODaJZAM4CA7bf" data-mapping="specific" data-term="2021/07/搭建无污染的DNS服务/" data-reactions-enabled="0" data-emit-metadata="0" data-input-position="top" data-theme="dark_dimmed" data-lang="zh-CN" data-loading="lazy" crossorigin="anonymous" async=""></script></div></div><div class="sidebar"><div class="widget"><h4>链接</h4><ul><li><a href="/friends/">友链</a></li><li><a href="https://www.travellings.cn/train.html">开往</a></li><li><a href="https://foreverblog.cn/go.html">虫洞</a></li><li><a href="/feed.xml">订阅（Atom)</a></li><li><a href="/rss2.xml">订阅（Rss)</a></li><li><a href="https://www.lisperati.com/logo.html"><img src="/assets/img/lisplogo_warning2_128.png" alt="Lisp logo warning" /></a></li><li><a href="https://www.fsf.org/appeal"><img src="/assets/img/6838639.png" alt="FSF appeal" /></a></li></ul><div><a href="https://xn--sr8hvo.ws/previous">←</a><a href="https://xn--sr8hvo.ws">IndieWeb Webring 💍</a><a href="https://xn--sr8hvo.ws/next">→</a></div><div><a href="https://fediring.net/previous?host=blog.southfox.me">←</a><a href="https://fediring.net">Fediring 💍</a><a href="https://fediring.net/next?host=blog.southfox.me">→</a></div></div><div class="widget"><h4>设置</h4><div><label for="font-select">字体设置：</label><select id="font-select"><option value="plain">普通</option><option value="zpix">像素</option></select></div></div><div class="widget"><h4>标签</h4><ul><li><a href="/tag/技术">技术</a></li><li><a href="/tag/DNS">DNS</a></li><li><a href="/tag/自托管">自托管</a></li></ul></div><div class="widget"><h4>目录</h4><ul><li><a href="#准备">准备</a></li><li><a href="#Coredns">Coredns</a></li><li><a href="#Pihole（可选）">Pihole （可选）</a></li><li><a href="#列表">列表</a></li><li><a href="#Dnsmasq">Dnsmasq</a></li><li><a href="#Dnsproxy">Dnsproxy</a></li><li><a href="#总结">总结</a></li></ul></div></div></div><footer class="footer"><div class="copyright"><div><p>© SouthFox 2026 ,Font by <a href="https://github.com/SolidZORO/zpix-pixel-font">Zpix</a></p></div><div><p>Power by <a href="https://dthompson.us/projects/haunt.html">haunt</a> ,source can be found <a href="https://git.southfox.me/southfox/blog">here</a></p></div></div></footer></body></html>