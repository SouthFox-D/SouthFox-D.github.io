<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" /><meta property="og:title" content="ä¸º Matrix åŠ å…¥è‡ªå®šä¹‰æ¨é€åŠŸèƒ½ â€” ç‹ç‹¸åèµ°çŸ£" /><meta property="og:site_name" content="ç‹ç‹¸åèµ°çŸ£" /><meta property="og:image" content="https://blog.southfox.me/favicon.png" /><meta name="fediverse:creator" content="SouthFox@foxsay.southfox.me" /><title>ä¸º Matrix åŠ å…¥è‡ªå®šä¹‰æ¨é€åŠŸèƒ½ â€” ç‹ç‹¸åèµ°çŸ£</title><link rel="me" href="https://foxsay.southfox.me/@SouthFox" /><link rel="me" href="https://codeberg.org/southfox" /><script src="/assets/js/lips.min.js"></script><link rel="stylesheet" href="/assets/css/main.css" /><script type="text/x-scheme">(let ((font (or (localStorage.getItem "font") "zpix")) (font-select (document.getElementById "font-select"))) (define (string=? a b) (== (a.cmp b) 0)) (define (loop-set options value) (let loop ((i 0)) (if (> i (- (length options) 1)) i (let ((option (get options i))) (if (string=? option.value value) (option.setAttribute "selected" #t) (loop (+ 1 i))))))) (define (set-font font-name) (localStorage.setItem "font" font-name) (document.documentElement.setAttribute "data-font" font-name) (if font-select (loop-set font-select.options font-name))) (font-select.addEventListener "change" (lambda (event) (set-font event.target.value))) (set-font font))</script><link rel="alternative" href="/feed.xml" title="ç‹ç‹¸åèµ°çŸ£" type="application/atom+xml" /><link rel="alternative" href="/rss2.xml" title="ç‹ç‹¸åèµ°çŸ£" type="application/rss+xml" /></head><body><nav class="nav"><a href="/" class="brand"><span>ç‹ç‹¸åèµ°çŸ£</span></a><input id="bmenub" type="checkbox" class="show" aria-label="open menu" /><label for="bmenub" class="burger pseudo button">â˜°</label><div class="menu"><a href="/archives/">å½’æ¡£</a><a href="/tags/">æ ‡ç­¾</a><a href="/search/">æœç´¢</a><a href="/about/">å…³äº</a></div></nav><div class="container flex"><div class="content"><main data-pagefind-body="true"><div><h2>ä¸º Matrix åŠ å…¥è‡ªå®šä¹‰æ¨é€åŠŸèƒ½</h2><h3>by SouthFox</h3><h3 data-pagefind-sort="date">2021-11-22</h3><div><p><code>Matrix</code> æ˜¯ä¸€ä¸ªå¼€æºçš„èŠå¤©åè®®ï¼Œå’Œ <code>XMPP</code> ä¸€æ ·çš„è”é‚¦åˆ¶è®¾è®¡ä¹Ÿä¿è¯äº†åƒç”µå­é‚®ä»¶ä¸€æ ·çš„é€šä¿¡ä¾¿æ·ã€‚</p><span id="more"></span><p>å¥½çš„åœ°æ–¹å¾ˆå¤šï¼Œä½†æœ€æ˜æ˜¾åå¤„å°±æ˜¯æ¨é€äº†ï¼Œå¯¹äºå³æ—¶é€šä¿¡æ¥è¯´ï¼Œæ²¡æœ‰æ¨é€æ˜¯éå¸¸å¤§çš„ä¸ä¾¿â€¦â€¦è™½ç„¶æ­å»º <code>Matrix</code> çš„åº”ç”¨ <code>Synapse</code> é…ç½®æ–‡ä»¶å¯ç”¨é‚®ç®±çš„è¯å¯ä»¥å¯ç”¨é‚®ä»¶é€šçŸ¥ï¼Œä¸è¿‡é‰´äºé‚®ä»¶æ—¶æ•ˆæ€§ä¹Ÿä¸æ˜¯å¾ˆé«˜ï¼Œæ‰€ä»¥éœ€è¦ä¸ªå…¶ä»–çš„æ¨é€æ‰‹æ®µã€‚ï¼ˆè°·æ­Œå¸‚åœºä¸‹çš„ <code>Element</code> é™„å¸¦äº†è°·æ­Œçš„æ¶ˆæ¯æ¨é€ï¼Œä¸è¿‡å¾ˆé—æ†¾åœ¨å›½å†…å¤„äºæ®‹åºŸçŠ¶æ€ã€‚ï¼‰</p><p>æ‰€å¹¸ <code>Synapse</code> è‡ªå¸¦çš„ <a href="https://spec.matrix.org/v1.1/client-server-api/" class="external_link">API</a> å¯ä»¥å®šä¹‰æ¨é€è§„åˆ™ï¼Œå®šä¹‰åå¸å·æ”¶åˆ°æ¶ˆæ¯ï¼ŒæœåŠ¡å™¨å°±å¯ä»¥å°†æ¶ˆæ¯ä»¥ <code>JSON</code> çš„å½¢å¼æ¨é€åˆ°è‡ªå®šä¹‰çš„åœ°å€ï¼Œæ¥ä¸ªæ›²çº¿æ•‘å›½ã€‚</p><h1 id="Gotify">Gotify</h1><p>æ¨é€ç”¨åˆ°çš„å·¥å…·ä¸º <code>Gotify</code> ï¼Œç‰¹ç‚¹æ˜¯ä½¿ç”¨ <code>GO</code> ç¼–å†™ï¼Œé«˜æ•ˆå¿«é€Ÿï¼Œä¸è¿‡ç¼ºç‚¹å°±æ˜¯å®‰å“å¾—å¸¸é©»åå°æ¥æ”¶æ¨é€ï¼Œä¸è¿‡è‡³å°‘è¦æ¯”è…¾è®¯å…¨å®¶æ¡¶åƒçš„ç”µè¦å°‘ã€‚</p><h2 id="ä¸‹è½½">ä¸‹è½½</h2><p>å» <a href="https://github.com/gotify/server/releases" class="external_link">Releases</a>å¤„æ‰¾åˆ°å¯¹åº”ç‰ˆæœ¬çš„ä¸‹è½½é“¾æ¥ï¼Œè§£å‹åˆ°<code>/opt/gotify/</code>ã€‚</p><pre><code>unzip gotify-file -d /opt/gotify/</code></pre><p>ç„¶åä¸‹è½½é…ç½®æ ·æ¿ã€‚</p><pre><code>mkdir /etc/gotify
wget -O /etc/gotify/config.yml https://raw.githubusercontent.com/gotify/server/master/config.example.yml</code></pre><p>ç¼–è¾‘ <code>/etc/gotify/config.yml</code>ã€‚å°† <code>port</code> æ”¹ä¸ºæ²¡æœ‰å ç”¨çš„ç«¯å£ï¼Œ <code>name</code> å’Œ <code>pass</code> æ˜¯ç®¡ç†å‘˜çš„ç”¨æˆ·åå’Œå¯†ç ã€‚</p><h1 id="Nginxåä»£">Nginx åä»£</h1><p>åœ¨ <code>nginx</code> çš„æ–°å»ºä¸€ä¸ªè™šæ‹Ÿä¸»æœºå¹¶åœ¨é…ç½®æ–‡ä»¶å¢åŠ ä»¥ä¸‹å†…å®¹ï¼š</p><pre><code>location / {
  proxy_pass         http://localhost:8080;
  rewrite ^/gotify(/.*) $1 break;
  proxy_http_version 1.1;

  # Ensuring it can use websockets
  proxy_set_header   Upgrade $http_upgrade;
  proxy_set_header   Connection &quot;upgrade&quot;;
  proxy_set_header   X-Real-IP $remote_addr;
  proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header   X-Forwarded-Proto http;
  proxy_redirect     http:// $scheme://;
}</code></pre><blockquote><p>proxy_set_header   Connection &quot;upgrade&quot;; è¿™ä¸€æ ä¸è¦æ¼äº†â€¦â€¦è¦ä¸ç„¶å¼€å¯ WS æ—¶ä¼šæŠ¥é”™â€¦â€¦</p></blockquote><h1 id="è®¾ç½®æœåŠ¡">è®¾ç½®æœåŠ¡</h1><p>æ–°å»ºå¹¶ç¼–è¾‘ <code>/etc/systemd/system/gotify.service</code>ã€‚</p><pre><code>[Unit]
Description=gotify service
After=network.target
Wants=network.target

[Service]
Type=simple
PIDFile=/run/gotify.pid
WorkingDirectory=/opt/gotify
ExecStart=/opt/gotify/gotify-file
RestartPreventExitStatus=23
Restart=always
RestartSec=10s

[Install]
WantedBy=multi-user.target</code></pre><p>ç„¶åå¼€å¯æœåŠ¡å¹¶è®¾ç½®æˆå¼€æœºå¯åŠ¨ã€‚</p><pre><code>systemctl start gotify
systemctl enable gotify</code></pre><p>æ²¡æœ‰æŠ¥é”™çš„è¯å°±å¯ä»¥æ‰“å¼€ <code>Nginx</code> é‡Œæ‰€è®¾ç½®çš„åŸŸåè¿›å…¥ç®¡ç†é¡µé¢äº†ï¼Œï¼ˆæ”¹å¯†ç ï¼‰ä¹‹åå°±å¯ä»¥æ–°å»ºåº”ç”¨äº†ï¼Œæ‹¿åˆ°æ¨é€ä»¤ç‰Œï¼Œå°±å¯ä»¥å‘æœåŠ¡å™¨è®¾ç½®æ¨é€è§„åˆ™äº†ã€‚</p><h2 id="è®¾ç½®æ¨é€">è®¾ç½®æ¨é€</h2><p>åœ¨å®˜æ–¹æ–‡æ¡£é‡Œï¼Œé€šè¿‡ /_matrix/client/v3/pushers/set <code>API</code> å°±å¯ä»¥è®¾ç½®æ¨é€è§„åˆ™äº†ï¼Œé€šè¿‡ <code>curl</code> ï¼Œæˆ–è€…å…¶ä»–æ–¹å¼å‘æœåŠ¡å™¨å¯¹åº”åœ°å€å‘é€ <code>POST</code> è¯·æ±‚å³å¯ä½¿ç”¨ã€‚</p><pre><code>curl 'https://server_url/_matrix/client/r0/pushers/set' -H 'Authorization: Bearer access_token' -H 'Content-Type: application/json' -X POST -d '{&quot;lang&quot;: &quot;en&quot;,&quot;kind&quot;: &quot;http&quot;,&quot;app_display_name&quot;: &quot;Gotify&quot;,&quot;device_display_name&quot;: &quot;Gotify&quot;,&quot;pushkey&quot;: &quot;Gotify-PushKey&quot;,&quot;app_id&quot;: &quot;zh.xxx.gotify&quot;,&quot;data&quot;: {&quot;url&quot;: &quot;https://Push_url/_matrix/push/v1/notify&quot;,&quot;format&quot;: &quot;full_event&quot;}}'</code></pre><p>è¯¦ç»†è¯´æ˜è¯·æŸ¥é˜…å®˜æ–¹ <a href="https://spec.matrix.org/v1.1/client-server-api/#post_matrixclientv3pushersset" class="external_link">æ–‡æ¡£</a> , å…¶ä¸­ <code>access_token</code> å¯ä»¥åœ¨åº”ç”¨é‡Œæ‹¿åˆ°ï¼Œ<code>pushkey</code> è®¾ç½®æˆ <code>Gotify-PushKey</code> çš„æ ·å­æ˜¯ä¸ºäº†åç»­å¤„ç†æ–¹ä¾¿â€¦â€¦ç°é˜¶æ®µæ¨é€åœ°å€å¿…é¡»åŒ…å« <code>/_matrix/push/v1/notify</code> è·¯å¾„ï¼Œå¦åˆ™ä¼šæŠ¥é”™ï¼Œæ‰€ä»¥ä¸å¾—ä¸è¿›è¡Œé¢å¤–å¤„ç†äº†â€¦â€¦</p><h2 id="æ¥æ”¶æ¨é€">æ¥æ”¶æ¨é€</h2><p>æœåŠ¡å™¨è®¾ç½®æ¨é€è§„åˆ™ä¹‹åå°±ä¼šå‘å¯¹åº”åœ°å€å‘é€æ•°æ®äº†ï¼Œå› ä¸ºæ¨é€åœ°å€ç°é˜¶æ®µå¿…é¡»åŒ…å« <code>/_matrix/push/v1/notify</code> è·¯å¾„ï¼Œæ‰€ä»¥ä¸å¾—ä¸å†è®¾ç½®ä¸€ä¸ªæ¥æ”¶æœåŠ¡ç„¶åè¿›è¡Œå¤„ç†äº†ã€‚</p><p>æ¥ä¸‹æ¥ä½¿ç”¨ <code>python</code> çš„ <code>flask</code> æ¡†æ¶ç®€å•æ­ä¸€ä¸ªæœåŠ¡ï¼Œé¦–å…ˆå…ˆå®‰è£…ç¯å¢ƒã€‚</p><pre><code><span class="syntax-symbol">pip3</span> <span class="syntax-symbol">install</span> <span class="syntax-symbol">flask</span>
<span class="syntax-symbol">pip3</span> <span class="syntax-symbol">install</span> <span class="syntax-symbol">flask</span><span class="syntax-operator">-</span><span class="syntax-symbol">apscheduler</span></code></pre><p>ç„¶åæ˜¯ä»£ç ï¼š</p><pre><code><span class="syntax-special">import</span> <span class="syntax-symbol">json</span>
<span class="syntax-special">import</span> <span class="syntax-symbol">requests</span>
<span class="syntax-special">import</span> <span class="syntax-symbol">datetime</span>

<span class="syntax-special">from</span> <span class="syntax-symbol">flask</span> <span class="syntax-special">import</span> <span class="syntax-symbol">Flask</span><span class="syntax-operator">,</span> <span class="syntax-symbol">jsonify</span><span class="syntax-operator">,</span> <span class="syntax-symbol">request</span>
<span class="syntax-special">from</span> <span class="syntax-symbol">flask_apscheduler</span> <span class="syntax-special">import</span> <span class="syntax-symbol">APScheduler</span>
<span class="syntax-symbol">app</span> <span class="syntax-operator">=</span> <span class="syntax-symbol">Flask</span><span class="syntax-open">(</span><span class="syntax-symbol">__name__</span><span class="syntax-close">)</span>
<span class="syntax-symbol">scheduler</span> <span class="syntax-operator">=</span> <span class="syntax-symbol">APScheduler</span><span class="syntax-open">(</span><span class="syntax-close">)</span>

<span class="syntax-symbol">scheduler</span><span class="syntax-operator">.</span><span class="syntax-symbol">start</span><span class="syntax-open">(</span><span class="syntax-close">)</span>

<span class="syntax-special">def</span> <span class="syntax-symbol">push_notification</span><span class="syntax-open">(</span><span class="syntax-symbol">push_data</span><span class="syntax-close">)</span><span class="syntax-operator">:</span>
    <span class="syntax-special">if</span> <span class="syntax-symbol">push_data</span><span class="syntax-open">[</span><span class="syntax-string">&quot;push_way&quot;</span><span class="syntax-close">]</span> <span class="syntax-operator">==</span> <span class="syntax-string">'Gotify'</span><span class="syntax-operator">:</span>
        <span class="syntax-symbol">resp</span> <span class="syntax-operator">=</span> <span class="syntax-symbol">requests</span><span class="syntax-operator">.</span><span class="syntax-symbol">post</span><span class="syntax-open">(</span><span class="syntax-symbol">f</span><span class="syntax-string">'https://push.xxx.xxx/message?token={push_data[&quot;push_token&quot;]}'</span><span class="syntax-operator">,</span> <span class="syntax-symbol">json</span><span class="syntax-operator">=</span><span class="syntax-open">{</span>
        <span class="syntax-string">&quot;message&quot;</span><span class="syntax-operator">:</span> <span class="syntax-symbol">f</span><span class="syntax-string">'ã€Œ{push_data[&quot;sender&quot;]}ã€å‘é€äº†æ¶ˆæ¯ç»™ä½ ã€‚'</span><span class="syntax-operator">,</span>
        <span class="syntax-string">&quot;priority&quot;</span><span class="syntax-operator">:</span> <span class="syntax-symbol">8</span><span class="syntax-operator">,</span>
        <span class="syntax-string">&quot;title&quot;</span><span class="syntax-operator">:</span> <span class="syntax-string">&quot;æ–°æ¶ˆæ¯ï¼&quot;</span>
        <span class="syntax-close">}</span><span class="syntax-close">)</span>
        <span class="syntax-keyword">print</span><span class="syntax-open">(</span><span class="syntax-symbol">resp</span><span class="syntax-close">)</span>
        <span class="syntax-special">return</span>
    <span class="syntax-special">if</span> <span class="syntax-symbol">push_data</span><span class="syntax-open">[</span><span class="syntax-string">&quot;push_way&quot;</span><span class="syntax-close">]</span> <span class="syntax-operator">==</span> <span class="syntax-string">'Bary'</span><span class="syntax-operator">:</span>
        <span class="syntax-special">try</span><span class="syntax-operator">:</span>
            <span class="syntax-symbol">response</span> <span class="syntax-operator">=</span> <span class="syntax-symbol">requests</span><span class="syntax-operator">.</span><span class="syntax-symbol">post</span><span class="syntax-open">(</span>
                <span class="syntax-symbol">url</span><span class="syntax-operator">=</span><span class="syntax-string">&quot;https://api.day.app/push&quot;</span><span class="syntax-operator">,</span>
                <span class="syntax-symbol">headers</span><span class="syntax-operator">=</span><span class="syntax-open">{</span>
                    <span class="syntax-string">&quot;Content-Type&quot;</span><span class="syntax-operator">:</span> <span class="syntax-string">&quot;application/json; charset=utf-8&quot;</span><span class="syntax-operator">,</span>
                <span class="syntax-close">}</span><span class="syntax-operator">,</span>
                <span class="syntax-symbol">data</span><span class="syntax-operator">=</span><span class="syntax-symbol">json</span><span class="syntax-operator">.</span><span class="syntax-symbol">dumps</span><span class="syntax-open">(</span><span class="syntax-open">{</span>
                    <span class="syntax-string">&quot;body&quot;</span><span class="syntax-operator">:</span> <span class="syntax-symbol">f</span><span class="syntax-string">'ã€Œ{push_data[&quot;sender&quot;]}ã€å‘é€äº†æ¶ˆæ¯ç»™ä½ ã€‚'</span><span class="syntax-operator">,</span>
                    <span class="syntax-string">&quot;device_key&quot;</span><span class="syntax-operator">:</span> <span class="syntax-symbol">push_data</span><span class="syntax-open">[</span><span class="syntax-string">&quot;push_token&quot;</span><span class="syntax-close">]</span><span class="syntax-operator">,</span>
                    <span class="syntax-string">&quot;title&quot;</span><span class="syntax-operator">:</span> <span class="syntax-string">&quot;æ–°æ¶ˆæ¯ï¼&quot;</span><span class="syntax-operator">,</span>
                    <span class="syntax-string">&quot;category&quot;</span><span class="syntax-operator">:</span> <span class="syntax-string">&quot;category&quot;</span><span class="syntax-operator">,</span>
                    <span class="syntax-string">&quot;sound&quot;</span><span class="syntax-operator">:</span> <span class="syntax-string">&quot;minuet.caf&quot;</span><span class="syntax-operator">,</span>
                <span class="syntax-close">}</span><span class="syntax-close">)</span>
            <span class="syntax-close">)</span>
            <span class="syntax-keyword">print</span><span class="syntax-open">(</span><span class="syntax-string">'Response HTTP Status Code: {status_code}'</span><span class="syntax-operator">.</span><span class="syntax-keyword">format</span><span class="syntax-open">(</span>
                <span class="syntax-symbol">status_code</span><span class="syntax-operator">=</span><span class="syntax-symbol">response</span><span class="syntax-operator">.</span><span class="syntax-symbol">status_code</span><span class="syntax-close">)</span><span class="syntax-close">)</span>
            <span class="syntax-keyword">print</span><span class="syntax-open">(</span><span class="syntax-string">'Response HTTP Response Body: {content}'</span><span class="syntax-operator">.</span><span class="syntax-keyword">format</span><span class="syntax-open">(</span>
                <span class="syntax-symbol">content</span><span class="syntax-operator">=</span><span class="syntax-symbol">response</span><span class="syntax-operator">.</span><span class="syntax-symbol">content</span><span class="syntax-close">)</span><span class="syntax-close">)</span>
        <span class="syntax-special">except</span> <span class="syntax-symbol">requests</span><span class="syntax-operator">.</span><span class="syntax-symbol">exceptions</span><span class="syntax-operator">.</span><span class="syntax-symbol">RequestException</span><span class="syntax-operator">:</span>
            <span class="syntax-keyword">print</span><span class="syntax-open">(</span><span class="syntax-string">'HTTP Request failed'</span><span class="syntax-close">)</span>
        <span class="syntax-special">return</span>


<span class="syntax-comment"># Our route that will receive the webhooks from Duffel's servers
</span><span class="syntax-operator">@</span><span class="syntax-symbol">app</span><span class="syntax-operator">.</span><span class="syntax-symbol">route</span><span class="syntax-open">(</span><span class="syntax-string">'/_matrix/push/v1/notify'</span><span class="syntax-operator">,</span> <span class="syntax-symbol">methods</span><span class="syntax-operator">=</span><span class="syntax-open">[</span><span class="syntax-string">'POST'</span><span class="syntax-close">]</span><span class="syntax-close">)</span>
<span class="syntax-special">def</span> <span class="syntax-symbol">hello_world</span><span class="syntax-open">(</span><span class="syntax-close">)</span><span class="syntax-operator">:</span>
    <span class="syntax-symbol">push_data</span> <span class="syntax-operator">=</span> <span class="syntax-open">{</span><span class="syntax-close">}</span>
    <span class="syntax-symbol">event</span> <span class="syntax-operator">=</span> <span class="syntax-special">None</span>

    <span class="syntax-special">try</span><span class="syntax-operator">:</span>
        <span class="syntax-symbol">event</span> <span class="syntax-operator">=</span> <span class="syntax-symbol">request</span><span class="syntax-operator">.</span><span class="syntax-symbol">json</span>
        <span class="syntax-keyword">print</span><span class="syntax-open">(</span><span class="syntax-symbol">event</span><span class="syntax-close">)</span>

    <span class="syntax-special">except</span><span class="syntax-operator">:</span>
        <span class="syntax-special">return</span> <span class="syntax-symbol">jsonify</span><span class="syntax-open">(</span><span class="syntax-symbol">success</span><span class="syntax-operator">=</span><span class="syntax-special">False</span><span class="syntax-close">)</span>

    <span class="syntax-comment"># Handle the event
</span>    <span class="syntax-special">if</span> <span class="syntax-symbol">event</span><span class="syntax-open">[</span><span class="syntax-string">&quot;notification&quot;</span><span class="syntax-close">]</span><span class="syntax-open">[</span><span class="syntax-string">&quot;type&quot;</span><span class="syntax-close">]</span> <span class="syntax-operator">==</span> <span class="syntax-string">'m.room.message'</span> <span class="syntax-special">or</span> <span class="syntax-symbol">event</span><span class="syntax-open">[</span><span class="syntax-string">&quot;notification&quot;</span><span class="syntax-close">]</span><span class="syntax-open">[</span><span class="syntax-string">&quot;type&quot;</span><span class="syntax-close">]</span> <span class="syntax-operator">==</span> <span class="syntax-string">'m.room.encrypted'</span><span class="syntax-operator">:</span>
        <span class="syntax-symbol">app_id</span> <span class="syntax-operator">=</span> <span class="syntax-symbol">event</span><span class="syntax-open">[</span><span class="syntax-string">&quot;notification&quot;</span><span class="syntax-close">]</span><span class="syntax-open">[</span><span class="syntax-string">&quot;devices&quot;</span><span class="syntax-close">]</span><span class="syntax-open">[</span><span class="syntax-symbol">0</span><span class="syntax-close">]</span><span class="syntax-open">[</span><span class="syntax-string">&quot;app_id&quot;</span><span class="syntax-close">]</span>
        <span class="syntax-symbol">push_data</span><span class="syntax-open">[</span><span class="syntax-string">&quot;push_way&quot;</span><span class="syntax-close">]</span><span class="syntax-operator">,</span> <span class="syntax-symbol">push_data</span><span class="syntax-open">[</span><span class="syntax-string">&quot;push_token&quot;</span><span class="syntax-close">]</span> <span class="syntax-operator">=</span> <span class="syntax-symbol">event</span><span class="syntax-open">[</span><span class="syntax-string">&quot;notification&quot;</span><span class="syntax-close">]</span><span class="syntax-open">[</span><span class="syntax-string">&quot;devices&quot;</span><span class="syntax-close">]</span><span class="syntax-open">[</span><span class="syntax-symbol">0</span><span class="syntax-close">]</span><span class="syntax-open">[</span><span class="syntax-string">&quot;pushkey&quot;</span><span class="syntax-close">]</span><span class="syntax-operator">.</span><span class="syntax-symbol">split</span><span class="syntax-open">(</span><span class="syntax-string">'-'</span><span class="syntax-close">)</span>
        <span class="syntax-symbol">push_data</span><span class="syntax-open">[</span><span class="syntax-string">&quot;sender&quot;</span><span class="syntax-close">]</span> <span class="syntax-operator">=</span> <span class="syntax-symbol">event</span><span class="syntax-open">[</span><span class="syntax-string">&quot;notification&quot;</span><span class="syntax-close">]</span><span class="syntax-open">[</span><span class="syntax-string">&quot;sender_display_name&quot;</span><span class="syntax-close">]</span>

        <span class="syntax-symbol">scheduler</span><span class="syntax-operator">.</span><span class="syntax-symbol">add_job</span><span class="syntax-open">(</span>
            <span class="syntax-symbol">func</span><span class="syntax-operator">=</span><span class="syntax-symbol">push_notification</span><span class="syntax-operator">,</span>
            <span class="syntax-symbol">args</span><span class="syntax-operator">=</span><span class="syntax-open">(</span><span class="syntax-symbol">push_data</span><span class="syntax-operator">,</span><span class="syntax-close">)</span><span class="syntax-operator">,</span>
            <span class="syntax-comment"># trigger=&quot;date&quot;,
</span>            <span class="syntax-symbol">next_run_time</span><span class="syntax-operator">=</span><span class="syntax-symbol">datetime</span><span class="syntax-operator">.</span><span class="syntax-symbol">datetime</span><span class="syntax-operator">.</span><span class="syntax-symbol">now</span><span class="syntax-open">(</span><span class="syntax-close">)</span> <span class="syntax-operator">+</span> <span class="syntax-symbol">datetime</span><span class="syntax-operator">.</span><span class="syntax-symbol">timedelta</span><span class="syntax-open">(</span><span class="syntax-symbol">seconds</span><span class="syntax-operator">=</span><span class="syntax-symbol">25</span><span class="syntax-close">)</span><span class="syntax-operator">,</span>
            <span class="syntax-keyword">id</span><span class="syntax-operator">=</span><span class="syntax-symbol">app_id</span><span class="syntax-operator">,</span>
            <span class="syntax-symbol">replace_existing</span><span class="syntax-operator">=</span><span class="syntax-special">True</span><span class="syntax-operator">,</span>
        <span class="syntax-close">)</span>

        <span class="syntax-keyword">print</span><span class="syntax-open">(</span><span class="syntax-string">'âœ…add push job!'</span><span class="syntax-close">)</span>

    <span class="syntax-special">if</span> <span class="syntax-symbol">event</span><span class="syntax-open">[</span><span class="syntax-string">&quot;notification&quot;</span><span class="syntax-close">]</span><span class="syntax-open">[</span><span class="syntax-string">&quot;type&quot;</span><span class="syntax-close">]</span> <span class="syntax-operator">==</span> <span class="syntax-special">None</span> <span class="syntax-special">and</span> <span class="syntax-symbol">event</span><span class="syntax-open">[</span><span class="syntax-string">&quot;notification&quot;</span><span class="syntax-close">]</span><span class="syntax-open">[</span><span class="syntax-string">&quot;id&quot;</span><span class="syntax-close">]</span> <span class="syntax-operator">==</span> <span class="syntax-string">''</span><span class="syntax-operator">:</span>
        <span class="syntax-symbol">app_id</span> <span class="syntax-operator">=</span> <span class="syntax-symbol">event</span><span class="syntax-open">[</span><span class="syntax-string">&quot;notification&quot;</span><span class="syntax-close">]</span><span class="syntax-open">[</span><span class="syntax-string">&quot;devices&quot;</span><span class="syntax-close">]</span><span class="syntax-open">[</span><span class="syntax-symbol">0</span><span class="syntax-close">]</span><span class="syntax-open">[</span><span class="syntax-string">&quot;app_id&quot;</span><span class="syntax-close">]</span>
        <span class="syntax-special">try</span><span class="syntax-operator">:</span>
            <span class="syntax-symbol">scheduler</span><span class="syntax-operator">.</span><span class="syntax-symbol">remove_job</span><span class="syntax-open">(</span><span class="syntax-keyword">id</span><span class="syntax-operator">=</span><span class="syntax-symbol">app_id</span><span class="syntax-close">)</span>
        <span class="syntax-special">except</span><span class="syntax-operator">:</span>
            <span class="syntax-special">pass</span>
        <span class="syntax-keyword">print</span><span class="syntax-open">(</span><span class="syntax-string">'âœ…remove push!'</span><span class="syntax-close">)</span>

    <span class="syntax-special">return</span> <span class="syntax-symbol">jsonify</span><span class="syntax-open">(</span><span class="syntax-symbol">success</span><span class="syntax-operator">=</span><span class="syntax-special">True</span><span class="syntax-close">)</span></code></pre><p>ç„¶åç”¨å‘½ä»¤ <code>FLASK_ENV=development FLASK_RUN_PORT=4567 FLASK_APP=webhook.py flask run</code> å°±å¯å¯ç”¨ã€‚å†ç„¶åå†ç”¨ <code>Nginx</code> åä»£ä¸€ä¸‹ <code>4567</code> ç«¯å£å°±è¡Œäº†ï¼Œå› ä¸º <code>Synapse</code> é»˜è®¤ç¦æ­¢æœ¬æœºè®¿é—®ï¼Œä¸ºäº†è§„èŒƒä¸€ç‚¹å°±å¦å¤–å¼€ä¸ªç«™ç‚¹æ¥æ”¶è¯·æ±‚å§â€¦â€¦</p><p>åŸºæœ¬é€»è¾‘å°±æ˜¯æ¥æ”¶ <code>JSON</code> æ‹¿åˆ°å‘é€è€…åç§°å’Œæ¨é€ä»¤ç‰Œï¼Œåˆ¤æ–­æ˜¯å“ªé¡¹æœåŠ¡ï¼Œç„¶åç­‰å¾…ä¸‰åç§’æ¨é€åˆ°å¯¹åº”çš„åº”ç”¨ä»¤ç‰Œä¸Šå»ï¼ŒæœŸé—´è¦æ˜¯åˆ¤æ–­ç”¨æˆ·å·²ç»é˜…è¯»äº†æ¶ˆæ¯ï¼Œå°±ç§»é™¤æ¨é€ä½œä¸šã€‚</p><p>åˆ°æ­¤æ— æ„å¤–çš„è¯ï¼Œåº”è¯¥å°±èƒ½æ­£å¸¸æ¨é€äº†ï¼Œéº»çƒ¦â€¦â€¦å¸Œæœ›ä»¥åèƒ½å¤Ÿæœ‰æ›´å‹å¥½ä¾¿æ·çš„æ–¹å¼å§ã€‚</p><h1 id="å‚è€ƒ">å‚è€ƒ</h1><ol><li><a href="https://blog.mjyai.com/2021/02/24/raspberry-pi-gotify/" class="external_link">åœ¨æ ‘è“æ´¾ä¸Šéƒ¨ç½²æ¶ˆæ¯æ¨é€è½¯ä»¶Gotify</a></li></ol></div></div></main><div class="pagination"><a class="btn" href="/2021/12/äºŒä¸€å¹´åäºŒæœˆä»½æ¢¦è®°/">â† ä¸Šä¸€é¡µ</a><a class="btn" href="/"> ä¸»é¡µ </a><a class="btn" href="/2021/11/äºŒä¸€å¹´åä¸€æœˆæ¢¦è®°/">ä¸‹ä¸€é¡µ â†’</a></div><div class="comment"><blockquote>å¦‚ä¸æƒ³æˆæƒ Giscus åº”ç”¨ï¼Œä¹Ÿå¯ä»¥ç‚¹å‡»ä¸‹æ–¹<strong>å·¦ä¸Šè§’æ•°å­—</strong>ç›´æ¥è·³è½¬åˆ° Github Discussions è¿›è¡Œè¯„è®ºã€‚</blockquote><script src="https://giscus.app/client.js" data-repo="SouthFox-D/SouthFox-D.github.io" data-repo-id="MDEwOlJlcG9zaXRvcnkyMjg3NDM0MjQ=" data-category="åšå®¢è¯„è®º" data-category-id="DIC_kwDODaJZAM4CA7bf" data-mapping="specific" data-term="2021/11/ä¸ºMatrixåŠ å…¥æ¨é€åŠŸèƒ½/" data-reactions-enabled="0" data-emit-metadata="0" data-input-position="top" data-theme="dark_dimmed" data-lang="zh-CN" data-loading="lazy" crossorigin="anonymous" async=""></script></div></div><div class="sidebar"><div class="widget"><h4>é“¾æ¥</h4><ul><li><a href="/friends/">å‹é“¾</a></li><li><a href="https://www.travellings.cn/train.html">å¼€å¾€</a></li><li><a href="https://foreverblog.cn/go.html">è™«æ´</a></li><li><a href="/feed.xml">è®¢é˜…ï¼ˆAtom)</a></li><li><a href="/rss2.xml">è®¢é˜…ï¼ˆRss)</a></li><li><a href="https://www.lisperati.com/logo.html"><img src="/assets/img/lisplogo_warning2_128.png" alt="Lisp logo warning" /></a></li><li><a href="https://www.fsf.org/appeal"><img src="/assets/img/6838639.png" alt="FSF appeal" /></a></li></ul><div><a href="https://xn--sr8hvo.ws/previous">â†</a><a href="https://xn--sr8hvo.ws">IndieWeb Webring ğŸ’</a><a href="https://xn--sr8hvo.ws/next">â†’</a></div><div><a href="https://fediring.net/previous?host=blog.southfox.me">â†</a><a href="https://fediring.net">Fediring ğŸ’</a><a href="https://fediring.net/next?host=blog.southfox.me">â†’</a></div></div><div class="widget"><h4>è®¾ç½®</h4><div><label for="font-select">å­—ä½“è®¾ç½®ï¼š</label><select id="font-select"><option value="plain">æ™®é€š</option><option value="zpix">åƒç´ </option></select></div></div><div class="widget"><h4>æ ‡ç­¾</h4><ul><li><a href="/tag/æŠ€æœ¯">æŠ€æœ¯</a></li><li><a href="/tag/Matrix">Matrix</a></li></ul></div><div class="widget"><h4>ç›®å½•</h4><ul><li><a href="#Gotify">Gotify</a></li><li><a href="#ä¸‹è½½">ä¸‹è½½</a></li><li><a href="#Nginxåä»£">Nginx åä»£</a></li><li><a href="#è®¾ç½®æœåŠ¡">è®¾ç½®æœåŠ¡</a></li><li><a href="#è®¾ç½®æ¨é€">è®¾ç½®æ¨é€</a></li><li><a href="#æ¥æ”¶æ¨é€">æ¥æ”¶æ¨é€</a></li><li><a href="#å‚è€ƒ">å‚è€ƒ</a></li></ul></div></div></div><footer class="footer"><div class="copyright"><div><p>Â© SouthFox 2026 ,Font by <a href="https://github.com/SolidZORO/zpix-pixel-font">Zpix</a></p></div><div><p>Power by <a href="https://dthompson.us/projects/haunt.html">haunt</a> ,source can be found <a href="https://git.southfox.me/southfox/blog">here</a></p></div></div></footer></body></html>