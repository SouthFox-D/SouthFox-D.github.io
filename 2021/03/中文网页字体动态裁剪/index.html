<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" /><meta property="og:title" content="中文网页字体动态裁剪 — 狐狸反走矣" /><meta property="og:site_name" content="狐狸反走矣" /><meta property="og:image" content="https://blog.southfox.me/favicon.png" /><meta name="fediverse:creator" content="SouthFox@foxsay.southfox.me" /><title>中文网页字体动态裁剪 — 狐狸反走矣</title><link rel="me" href="https://foxsay.southfox.me/@SouthFox" /><link rel="me" href="https://codeberg.org/southfox" /><script src="/assets/js/lips.min.js"></script><link rel="stylesheet" href="/assets/css/main.css" /><script type="text/x-scheme">(let ((font (or (localStorage.getItem "font") "zpix")) (font-select (document.getElementById "font-select"))) (define (string=? a b) (== (a.cmp b) 0)) (define (loop-set options value) (let loop ((i 0)) (if (> i (- (length options) 1)) i (let ((option (get options i))) (if (string=? option.value value) (option.setAttribute "selected" #t) (loop (+ 1 i))))))) (define (set-font font-name) (localStorage.setItem "font" font-name) (document.documentElement.setAttribute "data-font" font-name) (if font-select (loop-set font-select.options font-name))) (font-select.addEventListener "change" (lambda (event) (set-font event.target.value))) (set-font font))</script><link rel="alternative" href="/feed.xml" title="狐狸反走矣" type="application/atom+xml" /><link rel="alternative" href="/rss2.xml" title="狐狸反走矣" type="application/rss+xml" /></head><body><nav class="nav"><a href="/" class="brand"><span>狐狸反走矣</span></a><input id="bmenub" type="checkbox" class="show" aria-label="open menu" /><label for="bmenub" class="burger pseudo button">☰</label><div class="menu"><a href="/archives/">归档</a><a href="/tags/">标签</a><a href="/search/">搜索</a><a href="/about/">关于</a></div></nav><div class="container flex"><div class="content"><main data-pagefind-body="true"><div><h2>中文网页字体动态裁剪</h2><h3>by SouthFox</h3><h3 data-pagefind-sort="date">2021-03-12</h3><div><p>首先，我先在放个【矣】在这里。</p><span id="more"></span><p>比起字母系统语言，汉语在计算机世界上有着天然的弱势，<strong>锟斤拷</strong>和<strong>锘锘锘</strong>这些编码问题本身就令人头大了，尤其对于互联网这个寸土寸金之地，想要在网页内展现自定义字体，首先就要先加载个几兆大小的字体文件，要这么做那就是极度的浪费和折磨了。</p><p>所以字体裁剪是必要的，有两种方向：</p><ul><li><p>提前准备常用字集进行裁剪</p></li><li><p>提前计算出需要展示的字集再进行裁剪</p></li></ul><p>第一种方式就是突出一个极致的懒，只需要做一次，就能不用再管了。缺点就是总会有不在常用字体里的“常用字”，这样网页加载出来的效果就会形成“犬牙交错”之感，看起来非常辣眼（要是选用的字体和默认字体差别非常大的话）。而且常用字内其实也不是每个字都用上了，所以还是会有浪费。</p><p>第二种方式就更优雅一点了，能保证字体里的每个字都是用上的。缺点就是麻烦了点儿，不过只要写个自动化脚本，这点麻烦也不算麻烦了。</p><h2 id="压缩方案">压缩方案</h2><p>当选 <a href="https://github.com/fonttools/fonttools" class="external_link">fonttools</a> ，至少这项目现在还活跃着，其他类似的字体项目都停滞了蛮久时间的了……好像。</p><p>要使用直接通过 <code>pip install</code> 安装 <code>fonttools</code>就行了，要是还想压成 <code>woff2</code> 这种压缩率更高的格式还得再安装个 <code>brotli</code> 。</p><p>使用命令：</p><p><code>pyftsubset &lt;字体&gt;.ttf --text-file=&lt;字符集文件&gt;</code></p><p>当然，也可用 <code>--text=</code> 的选项来直接后面跟所需字符。</p><p>要压成 <code>woff2</code> 格式可以用 <code>fonttools ttLib.woff2 compress &lt;压缩后字体&gt;.woff2 &lt;被压字体&gt;.ttf</code> 的方式。</p><h3 id="脚本代码">脚本代码</h3><p>反正一个简单粗暴的循环怼上去就得了，去重可以用集合来去。</p><pre><code><span class="syntax-special">import</span> <span class="syntax-symbol">os</span>

<span class="syntax-symbol">path</span> <span class="syntax-operator">=</span> <span class="syntax-symbol">os</span><span class="syntax-operator">.</span><span class="syntax-symbol">getcwd</span><span class="syntax-open">(</span><span class="syntax-close">)</span>

<span class="syntax-symbol">filelist</span> <span class="syntax-operator">=</span> <span class="syntax-open">[</span><span class="syntax-close">]</span>
<span class="syntax-special">for</span> <span class="syntax-symbol">root</span><span class="syntax-operator">,</span> <span class="syntax-symbol">dirs</span><span class="syntax-operator">,</span> <span class="syntax-symbol">files</span> <span class="syntax-special">in</span> <span class="syntax-symbol">os</span><span class="syntax-operator">.</span><span class="syntax-symbol">walk</span><span class="syntax-open">(</span><span class="syntax-symbol">path</span> <span class="syntax-operator">+</span> <span class="syntax-string">'/source'</span><span class="syntax-close">)</span><span class="syntax-operator">:</span>
    <span class="syntax-special">for</span> <span class="syntax-symbol">name</span> <span class="syntax-special">in</span> <span class="syntax-symbol">files</span> <span class="syntax-operator">:</span>
        <span class="syntax-symbol">filelist</span><span class="syntax-operator">.</span><span class="syntax-symbol">append</span><span class="syntax-open">(</span><span class="syntax-symbol">os</span><span class="syntax-operator">.</span><span class="syntax-symbol">path</span><span class="syntax-operator">.</span><span class="syntax-symbol">join</span><span class="syntax-open">(</span><span class="syntax-symbol">root</span><span class="syntax-operator">,</span> <span class="syntax-symbol">name</span><span class="syntax-close">)</span><span class="syntax-close">)</span>

<span class="syntax-symbol">strset</span> <span class="syntax-operator">=</span> <span class="syntax-keyword">set</span><span class="syntax-open">(</span><span class="syntax-open">[</span><span class="syntax-close">]</span><span class="syntax-close">)</span>
<span class="syntax-special">for</span> <span class="syntax-symbol">filename</span> <span class="syntax-special">in</span>  <span class="syntax-symbol">filelist</span><span class="syntax-operator">:</span>
    <span class="syntax-special">if</span> <span class="syntax-string">'.md'</span> <span class="syntax-special">not</span> <span class="syntax-special">in</span> <span class="syntax-symbol">filename</span><span class="syntax-operator">:</span>
        <span class="syntax-special">continue</span>

    <span class="syntax-special">with</span> <span class="syntax-keyword">open</span><span class="syntax-open">(</span><span class="syntax-symbol">filename</span><span class="syntax-operator">,</span> <span class="syntax-string">&quot;r&quot;</span><span class="syntax-operator">,</span><span class="syntax-symbol">encoding</span><span class="syntax-operator">=</span><span class="syntax-string">'utf-8'</span><span class="syntax-close">)</span> <span class="syntax-special">as</span> <span class="syntax-symbol">f</span><span class="syntax-operator">:</span>
        <span class="syntax-special">for</span> <span class="syntax-symbol">subset</span> <span class="syntax-special">in</span> <span class="syntax-symbol">f</span><span class="syntax-operator">.</span><span class="syntax-symbol">read</span><span class="syntax-open">(</span><span class="syntax-close">)</span><span class="syntax-operator">:</span>
            <span class="syntax-symbol">strset</span><span class="syntax-operator">.</span><span class="syntax-symbol">add</span><span class="syntax-open">(</span><span class="syntax-symbol">subset</span><span class="syntax-close">)</span>

<span class="syntax-symbol">str_</span> <span class="syntax-operator">=</span> <span class="syntax-string">''</span>
<span class="syntax-symbol">a</span> <span class="syntax-operator">=</span> <span class="syntax-symbol">0</span>
<span class="syntax-special">with</span> <span class="syntax-keyword">open</span><span class="syntax-open">(</span><span class="syntax-string">'strdb.txt'</span><span class="syntax-operator">,</span> <span class="syntax-string">&quot;w&quot;</span><span class="syntax-close">)</span> <span class="syntax-special">as</span> <span class="syntax-symbol">f</span><span class="syntax-operator">:</span>
    <span class="syntax-special">for</span> <span class="syntax-symbol">i</span> <span class="syntax-special">in</span> <span class="syntax-keyword">list</span><span class="syntax-open">(</span><span class="syntax-symbol">strset</span><span class="syntax-close">)</span><span class="syntax-operator">:</span>
        <span class="syntax-symbol">str_</span> <span class="syntax-operator">+</span><span class="syntax-operator">=</span> <span class="syntax-symbol">i</span>
        <span class="syntax-symbol">a</span> <span class="syntax-operator">+</span><span class="syntax-operator">=</span> <span class="syntax-symbol">1</span>
    <span class="syntax-keyword">print</span><span class="syntax-open">(</span><span class="syntax-string">'%d Characters in all files.'</span><span class="syntax-operator">%</span><span class="syntax-symbol">a</span><span class="syntax-close">)</span>
    <span class="syntax-keyword">print</span><span class="syntax-open">(</span><span class="syntax-symbol">str_</span><span class="syntax-close">)</span>
    <span class="syntax-symbol">f</span><span class="syntax-operator">.</span><span class="syntax-symbol">write</span><span class="syntax-open">(</span><span class="syntax-symbol">str_</span><span class="syntax-close">)</span></code></pre><p>将 <code>source</code> 下的 <code>md</code> 文件的字符提出来，再写入到 <code>strdb.txt</code> 以带后续使用。当然直接用 <code>--text=</code> 选项直接塞进命令里也可以，反正我是喜欢先写进文件的。</p><p>最后生成的字体文件在 80kb 左右，对于网页来说，已经是可以接受的程度了，当然这跟我选择的字体有关，是一款像素字体，不怎么占空间，如果是常规字体的话，大概会在上两三百左右吧。</p><h2 id="坑">坑</h2><ol><li>首先是 <code>Travis</code> 部署上得用 <code>python3</code> 环境，要特别声明一下，二环境下会输出个零蛋，应该是版本之间语法的锅？</li><li>代码里没有解析配置文件里的中文语句，所以标语口号这种，可能就会没被解析到，不过我懒地再一个一个引入配置文件，所以还不如……~~我先在放个【矣】在这里。~~</li><li>确保文本在网页字体加载期间保持可见状态，即设置 <code>font-display: swap</code>  选项 在<code>@font-face</code> 内，要不然的话字体没加载出来文本会消失掉。</li></ol><h2 id="参考">参考</h2><ol><li><p><a href="https://github.com/fonttools/fonttools" class="external_link">Fonttools</a></p></li><li><p><a href="https://hsingko.github.io/post/compress_webfont/" class="external_link">中文字体压缩的那些事——涂雨期的博客</a></p></li><li><p><a href="https://web.dev/font-display/" class="external_link">Font display</a></p></li></ol></div></div></main><div class="pagination"><a class="btn" href="/2021/03/出发，海底世界/">← 上一页</a><a class="btn" href="/"> 主页 </a><a class="btn" href="/2021/02/wrong/">下一页 →</a></div><div class="comment"><blockquote>如不想授权 Giscus 应用，也可以点击下方<strong>左上角数字</strong>直接跳转到 Github Discussions 进行评论。</blockquote><script src="https://giscus.app/client.js" data-repo="SouthFox-D/SouthFox-D.github.io" data-repo-id="MDEwOlJlcG9zaXRvcnkyMjg3NDM0MjQ=" data-category="博客评论" data-category-id="DIC_kwDODaJZAM4CA7bf" data-mapping="specific" data-term="2021/03/中文网页字体动态裁剪/" data-reactions-enabled="0" data-emit-metadata="0" data-input-position="top" data-theme="dark_dimmed" data-lang="zh-CN" data-loading="lazy" crossorigin="anonymous" async=""></script></div></div><div class="sidebar"><div class="widget"><h4>链接</h4><ul><li><a href="/friends/">友链</a></li><li><a href="https://www.travellings.cn/train.html">开往</a></li><li><a href="https://foreverblog.cn/go.html">虫洞</a></li><li><a href="/feed.xml">订阅（Atom)</a></li><li><a href="/rss2.xml">订阅（Rss)</a></li><li><a href="https://www.lisperati.com/logo.html"><img src="/assets/img/lisplogo_warning2_128.png" alt="Lisp logo warning" /></a></li><li><a href="https://www.fsf.org/appeal"><img src="/assets/img/6838639.png" alt="FSF appeal" /></a></li></ul><div><a href="https://xn--sr8hvo.ws/previous">←</a><a href="https://xn--sr8hvo.ws">IndieWeb Webring 💍</a><a href="https://xn--sr8hvo.ws/next">→</a></div><div><a href="https://fediring.net/previous?host=blog.southfox.me">←</a><a href="https://fediring.net">Fediring 💍</a><a href="https://fediring.net/next?host=blog.southfox.me">→</a></div></div><div class="widget"><h4>设置</h4><div><label for="font-select">字体设置：</label><select id="font-select"><option value="plain">普通</option><option value="zpix">像素</option></select></div></div><div class="widget"><h4>标签</h4><ul><li><a href="/tag/技术">技术</a></li><li><a href="/tag/字体">字体</a></li></ul></div><div class="widget"><h4>目录</h4><ul><li><a href="#压缩方案">压缩方案</a></li><li><a href="#脚本代码">脚本代码</a></li><li><a href="#坑">坑</a></li><li><a href="#参考">参考</a></li></ul></div></div></div><footer class="footer"><div class="copyright"><div><p>© SouthFox 2026 ,Font by <a href="https://github.com/SolidZORO/zpix-pixel-font">Zpix</a></p></div><div><p>Power by <a href="https://dthompson.us/projects/haunt.html">haunt</a> ,source can be found <a href="https://git.southfox.me/southfox/blog">here</a></p></div></div></footer></body></html>