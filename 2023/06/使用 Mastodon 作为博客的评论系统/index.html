<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" /><meta property="og:title" content="使用 Mastodon 作为博客的评论系统 — 狐狸反走矣" /><meta property="og:site_name" content="狐狸反走矣" /><meta property="og:image" content="https://blog.southfox.me/favicon.png" /><meta name="fediverse:creator" content="SouthFox@foxsay.southfox.me" /><title>使用 Mastodon 作为博客的评论系统 — 狐狸反走矣</title><link rel="me" href="https://foxsay.southfox.me/@SouthFox" /><link rel="me" href="https://codeberg.org/southfox" /><script src="/assets/js/lips.min.js"></script><link rel="stylesheet" href="/assets/css/main.css" /><script type="text/x-scheme">(let ((font (or (localStorage.getItem "font") "zpix")) (font-select (document.getElementById "font-select"))) (define (string=? a b) (== (a.cmp b) 0)) (define (loop-set options value) (let loop ((i 0)) (if (> i (- (length options) 1)) i (let ((option (get options i))) (if (string=? option.value value) (option.setAttribute "selected" #t) (loop (+ 1 i))))))) (define (set-font font-name) (localStorage.setItem "font" font-name) (document.documentElement.setAttribute "data-font" font-name) (if font-select (loop-set font-select.options font-name))) (font-select.addEventListener "change" (lambda (event) (set-font event.target.value))) (set-font font))</script><link rel="alternative" href="/feed.xml" title="狐狸反走矣" type="application/atom+xml" /><link rel="alternative" href="/rss2.xml" title="狐狸反走矣" type="application/rss+xml" /></head><body><nav class="nav"><a href="/" class="brand"><span>狐狸反走矣</span></a><input id="bmenub" type="checkbox" class="show" aria-label="open menu" /><label for="bmenub" class="burger pseudo button">☰</label><div class="menu"><a href="/archives/">归档</a><a href="/tags/">标签</a><a href="/search/">搜索</a><a href="/about/">关于</a></div></nav><div class="container flex"><div class="content"><main data-pagefind-body="true"><div><h2>使用 Mastodon 作为博客的评论系统</h2><h3>by SouthFox</h3><h3 data-pagefind-sort="date">2023-06-16</h3><div><p>又在博客的评论系统上左右摇摆了，就算没有人来评论。</p><span id="more"></span><p>之前写过一篇<a href="https://blog.southfox.me/2022/01/%E4%B8%BA%E5%8D%9A%E5%AE%A2%E6%94%AF%E6%8C%81%E8%AF%84%E8%AE%BA%E7%B3%BB%E7%BB%9F/" class="external_link">使用 Giscus 作为博客评论系统</a>的文章，一年下来的使用体验感受良好，只需要经过一点点配置就能为博客嵌入一个支持 <code>Markdown</code> 支持、代码高亮、表情回应、邮件通知、数据背靠 <code>GitHub</code>的评论系统，性价比十分之高。但代价也是背靠 <code>GitHub</code> ，作为一个大商业公司「发病」是一个不断扔骰子的过程，随着时间流逝，扔出个「大发病」的概率将会趋近于必然。可能是什么「大会员」或是「API 收大费」。为了避免最坏情况发生所以有必要准备一些备选方案。</p><p>比如 <a href="https://cusdis.com/" class="external_link">Cusdis</a> 是我之前尝试过一阵的评论系统方案，虽然各方面都比较优秀，但是它上面的一些小小「毛刺」最终让我放弃继续使用（主要是一些样式问题），更大的原因也是我开始觉得为了一年不到十多条的评论是否有必要开一个数据库+评论系统。</p><p>所以最后是打算复用一些已经建立的应用作为博客的评论系统，例如 <a href="https://cactus.chat/" class="external_link">cactus</a> 评论系统就可以使用 <code>Matrix</code> 聊天协议作为博客的评论系统。不过我觉得着有点「重」了，而且 <code>Matrix</code> 主流实现 <code>Synapse</code> 对于房间、媒体管理这些支持并不算太好，要是被恶意刷请求之后很难清理干净。</p><p>所以最后将目光放向了 <code>Mastodon</code> ，现在谷歌上搜索 <code>mastodon blog comment</code>  就能搜索出很多方案，本次我也是参（tou）考（qie）整（feng）合（he）了其中两篇的解决方案：</p><p><a href="https://blog.thms.uk/2023/02/mastodon-comments" class="external_link">Adding comments to your blog, powered by mastodon</a></p><p><a href="https://danielpecos.com/2022/12/25/mastodon-as-comment-system-for-your-static-blog/" class="external_link">Mastodon as comment system for your static blog</a></p><p>主要思想就是利用 <code>Mastodon</code> 的帖子 <code>API</code> 获取一条博文下的所有回复，然后处理后插入的指定位置，并不是太复杂。</p><h2 id="实现">实现</h2><p>作为一个备选方案我并没有删掉之前基于 <code>Giscus</code> 的评论方案，现在是处于共存状态。要启用基于 <code>Mastodon</code> 的方案就在文章的元数据中指定 <code>fedi_url</code> 这个变量：</p><pre><code>&lt;% if (item.no_comment){ %&gt;
  &lt;!-- no comment --&gt;
&lt;% } else { %&gt;
  &lt;% if (item.fedi_url){ %&gt;
    &lt;div id=&quot;comments&quot;&gt;
      &lt;p id=&quot;mastodon-comments-list&quot;&gt;&lt;/p&gt;
      &lt;script src=&quot;&lt;%- url_for('./js/fedicomment.js') %&gt;&quot; post-url=&quot;&lt;%- item.fedi_url %&gt;&quot;&gt; async&lt;/script&gt;
    &lt;/div&gt;
    &lt;noscript&gt;Enable JavaScript to view the comments.&lt;/a&gt;&lt;/noscript&gt;
  &lt;% } else { %&gt;
    &lt;script src=&quot;https://giscus.app/client.js&quot;
				data-*=&quot;……&quot;
            async&gt;
    &lt;/script&gt;
  &lt;% } %&gt;
&lt;% } %&gt;</code></pre><p>然后引入 <code>fedicomment.js</code> 这个文件，不直接通过模板直接写入主要还是因为自己自找没趣设置了 <code>CSP</code> 禁止 <code>inline javascript</code> 。</p><pre><code>&lt;script src=&quot;&lt;%- url_for('./js/fedicomment.js') %&gt;&quot; post-url=&quot;&lt;%- item.fedi_url %&gt;&quot;&gt; async&lt;/script&gt;</code></pre><p>这一段指定了 <code>post-url</code> 这个属性，作为一个变量传入脚本文件里，参见：<a href="https://stackoverflow.com/questions/14904378/get-data-attribute-of-script-tag" class="external_link">Get data attribute of script tag?</a></p><p>之后在脚本文件里将作为全局变量调用：</p><pre><code><span class="syntax-special">var</span> <span class="syntax-symbol">post_url</span> <span class="syntax-operator">=</span> <span class="syntax-keyword">document</span><span class="syntax-operator">.</span><span class="syntax-symbol">currentScript</span><span class="syntax-operator">.</span><span class="syntax-symbol">getAttribute</span><span class="syntax-open">(</span><span class="syntax-string">&quot;post-url&quot;</span><span class="syntax-close">)</span><span class="syntax-operator">;</span></code></pre><p>实际的脚本文件课参见 <code>GitHub</code> 上： <a href="https://github.com/SouthFox-D/SouthFox-D.github.io/blob/hexo/themes/freemind/source/js/fedicomment.js" class="external_link">fedicomment.js</a> （毕竟要是直接复制过来也太凑字数了），不过实际也是整合了前面提到的两篇参考文章。</p><h2 id="缺点">缺点</h2><p>**麻烦：**使用这套方案的最大特点就是要多一步操作，因为 <code>Mastodon</code> 的帖子 <code>id</code> 是根据时间戳生成的，不能提前知晓。所以得在 Mastodon 发好文然后获取帖子链接才能插入到博文这里。或许通过配置自动构建的形式使用帐号的 <code>token</code> 预先发好帖然后自动插回文件再提交是种解决办法，但是肯定少不了折腾。而且虽说是在博客上的评论系统但是不能在博客上直接评论。</p><p>**管理：**如果不是身为站点管理员的话，那么将无法管理帖文下恶意评论，只能在站点层面的封禁才能移除评论。而且即使身为管理，想要删除单条帖文还得先进行「检举」操作标记这条帖文，然后在管理后台才能删除单条帖文的操作。</p><p>**限制：**如果站点开启了「安全模式」的话，那么将无法直接调用帖文的 <code>API</code> ，这样自然谈不上在博客中显示评论了。</p><h3 id="总结">总结</h3><p>总体来说，对于想复用服务的人或是联邦爱好者来说可以一试，不过其实相比 <code>Mastodon</code> ，直接在博客上用 <code>Serveless</code> 函数平台服务兼容 <code>ActivityPub</code> 协议似乎是个更好的选择？不过这就相当于从依赖 <code>GitHub</code> 改为依赖其它平台了……</p></div></div></main><div class="pagination"><a class="btn" href="/2023/06/GPG 浅尝辄止/">← 上一页</a><a class="btn" href="/"> 主页 </a><a class="btn" href="/2023/02/2022年终总结/">下一页 →</a></div><div class="comment"><blockquote>如不想授权 Giscus 应用，也可以点击下方<strong>左上角数字</strong>直接跳转到 Github Discussions 进行评论。</blockquote><script src="https://giscus.app/client.js" data-repo="SouthFox-D/SouthFox-D.github.io" data-repo-id="MDEwOlJlcG9zaXRvcnkyMjg3NDM0MjQ=" data-category="博客评论" data-category-id="DIC_kwDODaJZAM4CA7bf" data-mapping="specific" data-term="2023/06/使用 Mastodon 作为博客的评论系统/" data-reactions-enabled="0" data-emit-metadata="0" data-input-position="top" data-theme="dark_dimmed" data-lang="zh-CN" data-loading="lazy" crossorigin="anonymous" async=""></script></div></div><div class="sidebar"><div class="widget"><h4>链接</h4><ul><li><a href="/friends/">友链</a></li><li><a href="https://www.travellings.cn/train.html">开往</a></li><li><a href="https://foreverblog.cn/go.html">虫洞</a></li><li><a href="/feed.xml">订阅（Atom)</a></li><li><a href="/rss2.xml">订阅（Rss)</a></li><li><a href="https://www.lisperati.com/logo.html"><img src="/assets/img/lisplogo_warning2_128.png" alt="Lisp logo warning" /></a></li><li><a href="https://www.fsf.org/appeal"><img src="/assets/img/6838639.png" alt="FSF appeal" /></a></li></ul><div><a href="https://xn--sr8hvo.ws/previous">←</a><a href="https://xn--sr8hvo.ws">IndieWeb Webring 💍</a><a href="https://xn--sr8hvo.ws/next">→</a></div><div><a href="https://fediring.net/previous?host=blog.southfox.me">←</a><a href="https://fediring.net">Fediring 💍</a><a href="https://fediring.net/next?host=blog.southfox.me">→</a></div></div><div class="widget"><h4>设置</h4><div><label for="font-select">字体设置：</label><select id="font-select"><option value="plain">普通</option><option value="zpix">像素</option></select></div></div><div class="widget"><h4>标签</h4><ul><li><a href="/tag/Mastodon">Mastodon</a></li><li><a href="/tag/联邦宇宙">联邦宇宙</a></li><li><a href="/tag/技术">技术</a></li></ul></div><div class="widget"><h4>目录</h4><ul><li><a href="#实现">实现</a></li><li><a href="#缺点">缺点</a></li><li><a href="#总结">总结</a></li></ul></div></div></div><footer class="footer"><div class="copyright"><div><p>© SouthFox 2026 ,Font by <a href="https://github.com/SolidZORO/zpix-pixel-font">Zpix</a></p></div><div><p>Power by <a href="https://dthompson.us/projects/haunt.html">haunt</a> ,source can be found <a href="https://git.southfox.me/southfox/blog">here</a></p></div></div></footer></body></html>